# Siri Shortcuts æ’ä»¶æ–¹æ³•è°ƒç”¨æŒ‡å—

## æ¦‚è¿°

é€šè¿‡ **CallPluginMethodIntent**,ä½ å¯ä»¥åœ¨ Siri Shortcuts ä¸­è°ƒç”¨ Memento ä»»æ„æ’ä»¶çš„ JavaScript API,æ— éœ€ä¸ºæ¯ä¸ªåŠŸèƒ½ç¼–å†™ä¸“ç”¨çš„ AppIntentã€‚

## æ¶æ„è¯´æ˜

```
Siri/Shortcuts â†’ CallPluginMethodIntent (iOS) â†’ IntelligencePlugin
   â†’ ShortcutsHandlerService (Dart) â†’ JSBridgeManager
   â†’ æ’ä»¶ JavaScript API â†’ æ’ä»¶ Dart æ–¹æ³•
```

**ä¼˜åŠ¿:**
- âœ… **ä»£ç å¤ç”¨**: ç›´æ¥ä½¿ç”¨ç°æœ‰çš„ `tools/*.json` API å®šä¹‰
- âœ… **åŠ¨æ€æ‰©å±•**: æ–°å¢æ’ä»¶æ–¹æ³•åè‡ªåŠ¨æ”¯æŒ,æ— éœ€ä¿®æ”¹ Shortcuts ä»£ç 
- âœ… **ç»Ÿä¸€ç»´æŠ¤**: åªéœ€ç»´æŠ¤ä¸€å¥— JavaScript API
- âœ… **çµæ´»å‚æ•°**: æ”¯æŒå¤æ‚çš„ JSON å‚æ•°ä¼ é€’

---

## å¿«é€Ÿå¼€å§‹

### 1. åœ¨ Xcode ä¸­æ·»åŠ  AppIntent

ç¡®ä¿ `ios/Runner/CallPluginMethodIntent.swift` å·²åŒ…å«åœ¨ä½ çš„ Xcode é¡¹ç›®ä¸­ã€‚

**æ£€æŸ¥æ­¥éª¤:**
1. æ‰“å¼€ Xcode é¡¹ç›®
2. åœ¨å·¦ä¾§æ–‡ä»¶åˆ—è¡¨ä¸­æ‰¾åˆ° `Runner/CallPluginMethodIntent.swift`
3. ç¡®ä¿è¯¥æ–‡ä»¶å·²å‹¾é€‰ Target Membership: `Runner`

### 2. æ„å»º iOS åº”ç”¨

```bash
cd ios
pod install
cd ..
flutter build ios
```

### 3. åœ¨ iPhone çš„"å¿«æ·æŒ‡ä»¤" App ä¸­åˆ›å»º

æ‰“å¼€ iPhone çš„"å¿«æ·æŒ‡ä»¤" App:

1. ç‚¹å‡»å³ä¸Šè§’ **+** åˆ›å»ºæ–°å¿«æ·æŒ‡ä»¤
2. ç‚¹å‡» **æ·»åŠ æ“ä½œ**
3. æœç´¢ **"è°ƒç”¨æ’ä»¶æ–¹æ³•"** (æˆ– "Call Plugin Method")
4. é…ç½®å‚æ•°:
   - **æ’ä»¶ID**: ä¾‹å¦‚ `todo`
   - **æ–¹æ³•å**: ä¾‹å¦‚ `createTodo`
   - **å‚æ•°**: JSON æ ¼å¼,ä¾‹å¦‚ `{"title":"ä¹°èœ","priority":"high"}`

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: åˆ›å»ºå¾…åŠäº‹é¡¹

**å¿«æ·æŒ‡ä»¤é…ç½®:**
```
åŠ¨ä½œ: è°ƒç”¨æ’ä»¶æ–¹æ³•
æ’ä»¶ID: todo
æ–¹æ³•å: createTodo
å‚æ•°: {"title":"ä¹°èœ","priority":"high","dueDate":"2025-12-31"}
```

**æ•ˆæœ:**
è°ƒç”¨ `Memento.plugins.todo.createTodo({...})`,åˆ›å»ºä¸€æ¡æ–°çš„å¾…åŠäº‹é¡¹ã€‚

---

### ç¤ºä¾‹ 2: æŸ¥è¯¢ä»Šæ—¥æ—¥è®°

**å¿«æ·æŒ‡ä»¤é…ç½®:**
```
åŠ¨ä½œ: è°ƒç”¨æ’ä»¶æ–¹æ³•
æ’ä»¶ID: diary
æ–¹æ³•å: getDiaryByDate
å‚æ•°: {"date":"2025-12-25"}
```

**æ•ˆæœ:**
è¿”å›æŒ‡å®šæ—¥æœŸçš„æ—¥è®°å†…å®¹ã€‚

---

### ç¤ºä¾‹ 3: è®°å½•è´¦å•

**å¿«æ·æŒ‡ä»¤é…ç½®:**
```
åŠ¨ä½œ: è°ƒç”¨æ’ä»¶æ–¹æ³•
æ’ä»¶ID: bill
æ–¹æ³•å: createBill
å‚æ•°: {"amount":50.5,"category":"é¤é¥®","note":"åˆé¤"}
```

**æ•ˆæœ:**
è®°å½•ä¸€ç¬”æ–°çš„è´¦å•ã€‚

---

### ç¤ºä¾‹ 4: è°ƒç”¨æ— å‚æ•°æ–¹æ³•

**å¿«æ·æŒ‡ä»¤é…ç½®:**
```
åŠ¨ä½œ: è°ƒç”¨æ’ä»¶æ–¹æ³•
æ’ä»¶ID: todo
æ–¹æ³•å: getTodos
å‚æ•°: (ç•™ç©º)
```

**æ•ˆæœ:**
è·å–æ‰€æœ‰å¾…åŠäº‹é¡¹åˆ—è¡¨ã€‚

---

## å‚æ•°è¯´æ˜

### å¿…å¡«å‚æ•°

| å‚æ•°å | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| **æ’ä»¶ID** | String | æ’ä»¶çš„å”¯ä¸€æ ‡è¯†ç¬¦ | `todo`, `diary`, `bill` |
| **æ–¹æ³•å** | String | è¦è°ƒç”¨çš„ JavaScript API æ–¹æ³•å | `createTodo`, `getDiaryByDate` |

### å¯é€‰å‚æ•°

| å‚æ•°å | ç±»å‹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|------|--------|
| **å‚æ•°** | JSON String | æ–¹æ³•å‚æ•°,å¿…é¡»æ˜¯åˆæ³•çš„ JSON å¯¹è±¡ | `{}` |
| **åå°æ‰§è¡Œ** | Boolean | æ˜¯å¦åœ¨åå°æ‰§è¡Œ(ä¸æ‰“å¼€ App) | `false` |

---

## JSON å‚æ•°æ ¼å¼

å‚æ•°å¿…é¡»æ˜¯**åˆæ³•çš„ JSON å¯¹è±¡**,æ”¯æŒä»¥ä¸‹ç±»å‹:

### åŸºæœ¬ç±»å‹
```json
{
  "title": "ä¹°èœ",           // å­—ç¬¦ä¸²
  "amount": 50.5,            // æ•°å­—
  "completed": false,        // å¸ƒå°”å€¼
  "tags": null               // null
}
```

### åµŒå¥—å¯¹è±¡
```json
{
  "user": {
    "name": "å¼ ä¸‰",
    "age": 25
  }
}
```

### æ•°ç»„
```json
{
  "tags": ["å·¥ä½œ", "é‡è¦"],
  "participants": [1, 2, 3]
}
```

### æ—¥æœŸæ—¶é—´
```json
{
  "dueDate": "2025-12-31",
  "createdAt": "2025-12-25T10:30:00Z"
}
```

---

## å¦‚ä½•æŸ¥æ‰¾å¯ç”¨çš„æ’ä»¶å’Œæ–¹æ³•?

### æ–¹æ³• 1: æŸ¥çœ‹ tools/*.json æ–‡ä»¶

æ¯ä¸ªæ’ä»¶çš„å¯ç”¨æ–¹æ³•å®šä¹‰åœ¨ `lib/plugins/agent_chat/tools/{æ’ä»¶ID}.json` æ–‡ä»¶ä¸­ã€‚

**ç¤ºä¾‹: `lib/plugins/agent_chat/tools/todo.json`**
```json
{
  "plugin_id": "todo",
  "tools": [
    {
      "method": "createTodo",
      "title": "åˆ›å»ºå¾…åŠäº‹é¡¹",
      "parameters": [
        {"name": "title", "type": "string", "required": true},
        {"name": "priority", "type": "string", "enum": ["low","medium","high"]},
        {"name": "dueDate", "type": "string"}
      ]
    },
    {
      "method": "getTodos",
      "title": "è·å–å¾…åŠäº‹é¡¹åˆ—è¡¨",
      "parameters": []
    }
  ]
}
```

### æ–¹æ³• 2: åœ¨ App çš„"å·¥å…·ç®¡ç†"ç•Œé¢æŸ¥çœ‹

1. æ‰“å¼€ Memento App
2. è¿›å…¥ **Agent Chat** æ’ä»¶
3. ç‚¹å‡»å³ä¸Šè§’ **å·¥å…·ç®¡ç†**
4. æµè§ˆæ‰€æœ‰å¯ç”¨çš„æ’ä»¶å’Œæ–¹æ³•

---

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹æ—¥å¿—

è¿è¡Œ App æ—¶,æ‰“å¼€ Xcode çš„æ§åˆ¶å°æŸ¥çœ‹æ—¥å¿—:

```
[ShortcutsHandler] æ”¶åˆ° Shortcut æ•°æ®: {"action":"call_plugin_method",...}
[ShortcutsHandler] è°ƒç”¨æ’ä»¶æ–¹æ³•: todo.createTodo
[ShortcutsHandler] å‚æ•°: {"title":"ä¹°èœ"}
[ShortcutsHandler] ç”Ÿæˆçš„ JS ä»£ç : (async function() { ... })();
[ShortcutsHandler] æ‰§è¡Œç»“æœ: {"success":true,"data":{...}}
```

### 2. æµ‹è¯• JSON å‚æ•°

åœ¨åˆ›å»ºå¿«æ·æŒ‡ä»¤å‰,å…ˆåœ¨ JSON éªŒè¯å·¥å…·ä¸­éªŒè¯å‚æ•°æ ¼å¼:
- https://jsonlint.com/

### 3. å¸¸è§é”™è¯¯

| é”™è¯¯ä¿¡æ¯ | åŸå›  | è§£å†³æ–¹æ³• |
|----------|------|----------|
| `æ’ä»¶ID ä¸ºç©º` | æœªå¡«å†™æ’ä»¶ID | æ£€æŸ¥å¿«æ·æŒ‡ä»¤é…ç½® |
| `æ–¹æ³•å ä¸ºç©º` | æœªå¡«å†™æ–¹æ³•å | æ£€æŸ¥å¿«æ·æŒ‡ä»¤é…ç½® |
| `JS Bridge æœªåˆå§‹åŒ–` | App æœªå®Œå…¨å¯åŠ¨ | ç­‰å¾…å‡ ç§’åé‡è¯• |
| `å‚æ•° JSON è§£æå¤±è´¥` | JSON æ ¼å¼é”™è¯¯ | ä½¿ç”¨ jsonlint.com éªŒè¯ |
| `æ‰§è¡Œé”™è¯¯: ...` | æ–¹æ³•ä¸å­˜åœ¨æˆ–å‚æ•°é”™è¯¯ | æ£€æŸ¥ tools/*.json ä¸­çš„æ–¹æ³•å®šä¹‰ |

---

## é«˜çº§ç”¨æ³•

### 1. åœ¨å¿«æ·æŒ‡ä»¤ä¸­ä½¿ç”¨å˜é‡

**åœºæ™¯**: åˆ›å»º"å¿«é€Ÿè®°è´¦"å¿«æ·æŒ‡ä»¤,å¼¹å‡ºè¾“å…¥æ¡†è¦æ±‚è¾“å…¥é‡‘é¢

```
å¿«æ·æŒ‡ä»¤æ­¥éª¤:
1. "è¦æ±‚è¾“å…¥" â†’ æç¤ºæ–‡æœ¬: "è¯·è¾“å…¥é‡‘é¢" â†’ ä¿å­˜åˆ°å˜é‡: amount
2. "è°ƒç”¨æ’ä»¶æ–¹æ³•"
   - æ’ä»¶ID: bill
   - æ–¹æ³•å: createBill
   - å‚æ•°: {"amount": [å˜é‡ amount], "category": "é¤é¥®"}
```

**æ³¨æ„**: åœ¨å‚æ•° JSON ä¸­å¼•ç”¨å˜é‡æ—¶,éœ€è¦ä½¿ç”¨å¿«æ·æŒ‡ä»¤çš„å˜é‡è¯­æ³•ã€‚

### 2. ç»„åˆå¤šä¸ªæ“ä½œ

**åœºæ™¯**: åˆ›å»º"æ¯æ—¥æ€»ç»“"å¿«æ·æŒ‡ä»¤

```
å¿«æ·æŒ‡ä»¤æ­¥éª¤:
1. "è°ƒç”¨æ’ä»¶æ–¹æ³•" â†’ è·å–ä»Šæ—¥å¾…åŠ
   - æ’ä»¶ID: todo
   - æ–¹æ³•å: getTodos
   - å‚æ•°: {"completed":true}

2. "è°ƒç”¨æ’ä»¶æ–¹æ³•" â†’ è·å–ä»Šæ—¥æ—¥è®°
   - æ’ä»¶ID: diary
   - æ–¹æ³•å: getDiaryByDate
   - å‚æ•°: {"date":"[ä»Šå¤©æ—¥æœŸ]"}

3. "æ˜¾ç¤ºç»“æœ" â†’ å±•ç¤ºæ±‡æ€»ä¿¡æ¯
```

### 3. é…åˆ Siri è¯­éŸ³è¯†åˆ«

**åœºæ™¯**: é€šè¿‡è¯­éŸ³åˆ›å»ºå¾…åŠäº‹é¡¹

```
å¿«æ·æŒ‡ä»¤é…ç½®:
1. å¯ç”¨"è¯¢é—®æ—¶è¿è¡Œ"
2. "å¬å†™æ–‡æœ¬" â†’ ä¿å­˜åˆ°å˜é‡: taskTitle
3. "è°ƒç”¨æ’ä»¶æ–¹æ³•"
   - æ’ä»¶ID: todo
   - æ–¹æ³•å: createTodo
   - å‚æ•°: {"title": [å˜é‡ taskTitle]}
```

**ä½¿ç”¨**: å¯¹ Siri è¯´ "è¿è¡Œ[å¿«æ·æŒ‡ä»¤åç§°]" â†’ Siri ä¼šè¦æ±‚ä½ è¯´å‡ºå¾…åŠäº‹é¡¹ â†’ è‡ªåŠ¨åˆ›å»º

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å‡å°‘ä¸å¿…è¦çš„æ•°æ®ä¼ è¾“

ä½¿ç”¨ `mode` å’Œ `fields` å‚æ•°è¿‡æ»¤è¿”å›æ•°æ®:

```json
{
  "mode": "summary",
  "fields": ["id", "title", "completed"]
}
```

### 2. åå°æ‰§è¡Œ

å¯¹äºä¸éœ€è¦æ˜¾ç¤ºç»“æœçš„æ“ä½œ,å¯ç”¨"åå°æ‰§è¡Œ":

```
åå°æ‰§è¡Œ: æ˜¯
```

è¿™æ ·å¿«æ·æŒ‡ä»¤ä¼šç«‹å³è¿”å›,ä¸ä¼šç­‰å¾… App æ‰“å¼€ã€‚

---

## æ•…éšœæ’æŸ¥

### Q: å¿«æ·æŒ‡ä»¤ä¸­æ‰¾ä¸åˆ°"è°ƒç”¨æ’ä»¶æ–¹æ³•"åŠ¨ä½œ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹:
1. ç¡®è®¤ `CallPluginMethodIntent.swift` å·²åŠ å…¥ Xcode é¡¹ç›®
2. é‡æ–°æ„å»ºå¹¶å®‰è£… iOS App
3. åœ¨"å¿«æ·æŒ‡ä»¤" App ä¸­ä¸‹æ‹‰åˆ·æ–°å¯ç”¨åŠ¨ä½œåˆ—è¡¨

### Q: æ‰§è¡Œæ—¶æç¤º"JS Bridge æœªåˆå§‹åŒ–"

**A**: è¿™æ˜¯å› ä¸º App å¯åŠ¨æ—¶é—´è¾ƒé•¿,JS Bridge å°šæœªå®Œæˆåˆå§‹åŒ–ã€‚
- è§£å†³æ–¹æ³•: åœ¨å¿«æ·æŒ‡ä»¤ä¸­æ·»åŠ "ç­‰å¾… 2 ç§’"æ­¥éª¤
- æˆ–è€…ä½¿ç”¨ `evaluateWhenReady` æ–¹æ³•(å·²åœ¨ä»£ç ä¸­å®ç°)

### Q: å‚æ•°ä¼ é€’ä¸æ­£ç¡®

**A**: ç¡®ä¿ JSON æ ¼å¼å®Œå…¨æ­£ç¡®:
- å­—ç¬¦ä¸²å¿…é¡»ç”¨**åŒå¼•å·** `"` (ä¸èƒ½ç”¨å•å¼•å· `'`)
- é”®åå¿…é¡»ç”¨åŒå¼•å·
- æœ€å¤–å±‚å¿…é¡»æ˜¯å¯¹è±¡ `{}`

**é”™è¯¯ç¤ºä¾‹:**
```json
{'title': 'ä¹°èœ'}  // âŒ å•å¼•å·
{title: "ä¹°èœ"}     // âŒ é”®åæœªåŠ å¼•å·
["title"]           // âŒ æœ€å¤–å±‚æ˜¯æ•°ç»„
```

**æ­£ç¡®ç¤ºä¾‹:**
```json
{"title": "ä¹°èœ"}   // âœ…
```

---

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„ä¸“ç”¨ AppIntent

å¯¹äºé«˜é¢‘ä½¿ç”¨çš„åŠŸèƒ½,å¯ä»¥åˆ›å»ºä¸“ç”¨çš„ AppIntent ä»¥è·å¾—æ›´å¥½çš„ Siri ä½“éªŒ:

**ç¤ºä¾‹: åˆ›å»ºä¸“ç”¨çš„"å¿«é€Ÿè®°è´¦" Intent**

```swift
// ios/Runner/QuickBillIntent.swift
struct QuickBillIntent: AppIntent {
    static var title: LocalizedStringResource = "å¿«é€Ÿè®°è´¦"

    @Parameter(title: "é‡‘é¢")
    var amount: Double

    @Parameter(title: "åˆ†ç±»")
    var category: String

    @Parameter(title: "å¤‡æ³¨")
    var note: String?

    func perform() async throws -> some IntentResult {
        let params = [
            "amount": amount,
            "category": category,
            "note": note ?? ""
        ]

        let data = [
            "action": "call_plugin_method",
            "pluginId": "bill",
            "methodName": "createBill",
            "params": params
        ] as [String: Any]

        if let jsonData = try? JSONSerialization.data(withJSONObject: data),
           let jsonString = String(data: jsonData, encoding: .utf8) {
            IntelligencePlugin.notifier.push(jsonString)
        }

        return .result()
    }

    static var parameterSummary: some ParameterSummary {
        Summary("è®°è´¦ \(\.$amount) å…ƒ åˆ†ç±» \(\.$category)")
    }
}
```

**ä¼˜åŠ¿:**
- Siri å¯ä»¥ç›´æ¥è¯†åˆ«"è®°è´¦ 50 å…ƒ,åˆ†ç±»é¤é¥®"è¿™æ ·çš„è‡ªç„¶è¯­è¨€
- å‚æ•°ç±»å‹å®‰å…¨(ä¸éœ€è¦æ‰‹å†™ JSON)
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

**ä½•æ—¶ä½¿ç”¨ä¸“ç”¨ Intent vs é€šç”¨ Intent:**

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ |
|------|---------|
| é«˜é¢‘åŠŸèƒ½ (æ¯å¤©ä½¿ç”¨å¤šæ¬¡) | ä¸“ç”¨ Intent |
| éœ€è¦è‡ªç„¶è¯­è¨€è¯†åˆ« | ä¸“ç”¨ Intent |
| ä½é¢‘åŠŸèƒ½ (å¶å°”ä½¿ç”¨) | é€šç”¨ Intent |
| å¤æ‚å‚æ•° (åµŒå¥—å¯¹è±¡/æ•°ç»„) | é€šç”¨ Intent |
| æµ‹è¯•æ–°åŠŸèƒ½ | é€šç”¨ Intent |

---

## æ€»ç»“

é€šè¿‡ **CallPluginMethodIntent**,ä½ å¯ä»¥:
- âœ… æ— éœ€ç¼–å†™ Swift ä»£ç å³å¯è®© Siri è°ƒç”¨æ’ä»¶åŠŸèƒ½
- âœ… å¤ç”¨ç°æœ‰çš„ JavaScript API å®šä¹‰
- âœ… æ”¯æŒæ‰€æœ‰æ’ä»¶çš„æ‰€æœ‰æ–¹æ³•
- âœ… çµæ´»ä¼ é€’å¤æ‚å‚æ•°

å¼€å§‹åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªå¿«æ·æŒ‡ä»¤å§! ğŸš€

---

**ç›¸å…³æ–‡ä»¶:**
- iOS Intent: `ios/Runner/CallPluginMethodIntent.swift`
- Dart å¤„ç†å™¨: `lib/plugins/agent_chat/services/shortcuts_handler_service.dart`
- API å®šä¹‰: `lib/plugins/agent_chat/tools/*.json`
