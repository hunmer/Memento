<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memento JS Bridge æµ‹è¯•</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #4facfe;
        }

        h2 {
            color: #00f2fe;
            margin: 20px 0 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #000;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        button.danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .output {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
            color: #c9d1d9;
        }

        .output .success { color: #3fb950; }
        .output .error { color: #f85149; }
        .output .info { color: #58a6ff; }
        .output .warn { color: #d29922; }

        .status-bar {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #f85149;
        }

        .status-dot.connected {
            background: #3fb950;
            box-shadow: 0 0 10px #3fb950;
        }

        input[type="text"] {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 10px 12px;
            border-radius: 6px;
            width: 100%;
            margin-bottom: 10px;
            font-size: 14px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #4facfe;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group input {
            flex: 1;
            margin-bottom: 0;
        }

        .plugin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .plugin-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plugin-card:hover {
            background: rgba(79, 172, 254, 0.2);
            transform: translateY(-2px);
        }

        .plugin-card .icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .plugin-card .name {
            font-size: 12px;
            color: #8b949e;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Memento JS Bridge æµ‹è¯•</h1>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">æ£€æµ‹ä¸­...</span>
            </div>
            <button onclick="clearOutput()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <!-- ç³»ç»Ÿ API æµ‹è¯• -->
        <div class="section">
            <h2>ç³»ç»Ÿ API</h2>
            <div class="btn-group">
                <button onclick="testGetCurrentTime()">è·å–å½“å‰æ—¶é—´</button>
                <button onclick="testGetDeviceInfo()">è·å–è®¾å¤‡ä¿¡æ¯</button>
                <button onclick="testGetAppInfo()">è·å–åº”ç”¨ä¿¡æ¯</button>
            </div>
        </div>

        <!-- UI API æµ‹è¯• -->
        <div class="section">
            <h2>UI API</h2>
            <div class="input-group">
                <input type="text" id="toastMessage" placeholder="Toast æ¶ˆæ¯å†…å®¹" value="Hello from WebView!">
                <button onclick="testToast()">æ˜¾ç¤º Toast</button>
            </div>
            <div class="btn-group">
                <button class="secondary" onclick="testAlert()">æ˜¾ç¤º Alert</button>
                <button class="secondary" onclick="testConfirm()">æ˜¾ç¤º Confirm</button>
            </div>
        </div>

        <!-- WebView æ’ä»¶æµ‹è¯• -->
        <div class="section">
            <h2>WebView æ’ä»¶</h2>
            <div class="btn-group">
                <button onclick="testGetCards()">è·å–æ‰€æœ‰å¡ç‰‡</button>
                <button onclick="testGetTabs()">è·å–æ‰€æœ‰æ ‡ç­¾é¡µ</button>
            </div>
            <div class="input-group">
                <input type="text" id="cardTitle" placeholder="å¡ç‰‡æ ‡é¢˜" value="æµ‹è¯•å¡ç‰‡">
                <input type="text" id="cardUrl" placeholder="å¡ç‰‡ URL" value="https://example.com">
            </div>
            <div class="btn-group">
                <button class="success" onclick="testAddCard()">æ·»åŠ å¡ç‰‡</button>
                <button class="danger" onclick="testDeleteLastCard()">åˆ é™¤æœ€åä¸€å¼ å¡ç‰‡</button>
            </div>
        </div>

        <!-- å…¶ä»–æ’ä»¶æµ‹è¯• -->
        <div class="section">
            <h2>å…¶ä»–æ’ä»¶</h2>
            <div class="plugin-grid" id="pluginGrid">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- è‡ªå®šä¹‰è°ƒç”¨ -->
        <div class="section">
            <h2>è‡ªå®šä¹‰è°ƒç”¨</h2>
            <div class="input-group">
                <input type="text" id="customPluginId" placeholder="æ’ä»¶ ID" value="diary">
                <input type="text" id="customMethod" placeholder="æ–¹æ³•å" value="getEntries">
            </div>
            <input type="text" id="customParams" placeholder='å‚æ•° JSON (å¯é€‰)' value='{"limit": 10}'>
            <button onclick="testCustomCall()" style="width: 100%; margin-top: 10px;">æ‰§è¡Œè°ƒç”¨</button>
        </div>

        <!-- è¾“å‡ºåŒºåŸŸ -->
        <div class="section">
            <h2>è¾“å‡ºæ—¥å¿—</h2>
            <div class="output" id="output"></div>
        </div>
    </div>

    <script>
        // è¾“å‡ºæ—¥å¿—
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const time = new Date().toLocaleTimeString();
            const typeClass = type;

            let formattedMessage = message;
            if (typeof message === 'object') {
                formattedMessage = JSON.stringify(message, null, 2);
            }

            output.innerHTML += `<span class="${typeClass}">[${time}] ${formattedMessage}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // æ£€æµ‹ Memento Bridge æ˜¯å¦å¯ç”¨
        function checkBridge() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            if (typeof window.Memento !== 'undefined') {
                statusDot.classList.add('connected');
                statusText.textContent = 'Memento Bridge å·²è¿æ¥';
                log('Memento JS Bridge å·²è¿æ¥', 'success');
                return true;
            } else if (typeof window.flutter_inappwebview !== 'undefined') {
                statusDot.classList.add('connected');
                statusText.textContent = 'Flutter Bridge å·²è¿æ¥ (åŸç”Ÿ)';
                log('Flutter InAppWebView Bridge å·²è¿æ¥', 'warn');
                return true;
            } else {
                statusText.textContent = 'Bridge æœªè¿æ¥';
                log('Memento JS Bridge æœªè¿æ¥ï¼Œè¯·åœ¨ Memento WebView ä¸­æ‰“å¼€æ­¤é¡µé¢', 'error');
                return false;
            }
        }

        // åŒ…è£…è°ƒç”¨ä»¥å¤„ç† Bridge æœªæ³¨å…¥çš„æƒ…å†µ
        async function callMemento(callback) {
            try {
                if (typeof window.Memento === 'undefined') {
                    throw new Error('Memento Bridge æœªæ³¨å…¥');
                }
                const result = await callback();
                return result;
            } catch (error) {
                log(`é”™è¯¯: ${error.message}`, 'error');
                throw error;
            }
        }

        // ==================== ç³»ç»Ÿ API ====================

        async function testGetCurrentTime() {
            log('è°ƒç”¨: Memento.system.getCurrentTime()', 'info');
            try {
                const result = await callMemento(() => Memento.system.getCurrentTime());
                log(`å½“å‰æ—¶é—´: ${JSON.stringify(result)}`, 'success');
            } catch (e) {
                log(`è·å–æ—¶é—´å¤±è´¥: ${e.message}`, 'error');
            }
        }

        async function testGetDeviceInfo() {
            log('è°ƒç”¨: Memento.system.getDeviceInfo()', 'info');
            try {
                const result = await callMemento(() => Memento.system.getDeviceInfo());
                log(result, 'success');
            } catch (e) {
                log(`è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥: ${e.message}`, 'error');
            }
        }

        async function testGetAppInfo() {
            log('è°ƒç”¨: Memento.system.getAppInfo()', 'info');
            try {
                const result = await callMemento(() => Memento.system.getAppInfo());
                log(result, 'success');
            } catch (e) {
                log(`è·å–åº”ç”¨ä¿¡æ¯å¤±è´¥: ${e.message}`, 'error');
            }
        }

        // ==================== UI API ====================

        async function testToast() {
            const message = document.getElementById('toastMessage').value || 'Hello!';
            log(`è°ƒç”¨: Memento.ui.toast("${message}")`, 'info');
            try {
                await callMemento(() => Memento.ui.toast(message));
                log('Toast æ˜¾ç¤ºæˆåŠŸ', 'success');
            } catch (e) {
                log(`Toast å¤±è´¥: ${e.message}`, 'error');
            }
        }

        async function testAlert() {
            log('è°ƒç”¨: Memento.ui.alert(...)', 'info');
            try {
                await callMemento(() => Memento.ui.alert({
                    title: 'æµ‹è¯• Alert',
                    message: 'è¿™æ˜¯ä¸€ä¸ªæ¥è‡ª WebView çš„ Alert å¯¹è¯æ¡†',
                    buttonText: 'æˆ‘çŸ¥é“äº†'
                }));
                log('Alert å·²å…³é—­', 'success');
            } catch (e) {
                log(`Alert å¤±è´¥: ${e.message}`, 'error');
            }
        }

        async function testConfirm() {
            log('è°ƒç”¨: Memento.ui.confirm(...)', 'info');
            try {
                const result = await callMemento(() => Memento.ui.confirm({
                    title: 'ç¡®è®¤æ“ä½œ',
                    message: 'ä½ ç¡®å®šè¦æ‰§è¡Œè¿™ä¸ªæ“ä½œå—ï¼Ÿ',
                    confirmText: 'ç¡®å®š',
                    cancelText: 'å–æ¶ˆ'
                }));
                log(`ç”¨æˆ·é€‰æ‹©: ${result ? 'ç¡®å®š' : 'å–æ¶ˆ'}`, 'success');
            } catch (e) {
                log(`Confirm å¤±è´¥: ${e.message}`, 'error');
            }
        }

        // ==================== WebView æ’ä»¶ ====================

        async function testGetCards() {
            log('è°ƒç”¨: Memento.plugins.webview.getCards()', 'info');
            try {
                const result = await callMemento(() => Memento.plugins.webview.getCards());
                const data = typeof result === 'string' ? JSON.parse(result) : result;
                log(`è·å–åˆ° ${Array.isArray(data) ? data.length : 0} å¼ å¡ç‰‡:`, 'success');
                log(data, 'info');
            } catch (e) {
                log(`è·å–å¡ç‰‡å¤±è´¥: ${e.message}`, 'error');
            }
        }

        async function testGetTabs() {
            log('è°ƒç”¨: Memento.plugins.webview.getTabs()', 'info');
            try {
                const result = await callMemento(() => Memento.plugins.webview.getTabs());
                const data = typeof result === 'string' ? JSON.parse(result) : result;
                log(`è·å–åˆ° ${Array.isArray(data) ? data.length : 0} ä¸ªæ ‡ç­¾é¡µ:`, 'success');
                log(data, 'info');
            } catch (e) {
                log(`è·å–æ ‡ç­¾é¡µå¤±è´¥: ${e.message}`, 'error');
            }
        }

        async function testAddCard() {
            const title = document.getElementById('cardTitle').value || 'æµ‹è¯•å¡ç‰‡';
            const url = document.getElementById('cardUrl').value || 'https://example.com';

            log(`è°ƒç”¨: Memento.plugins.webview.addCard({title: "${title}", url: "${url}"})`, 'info');
            try {
                const result = await callMemento(() => Memento.plugins.webview.addCard({
                    title: title,
                    url: url,
                    type: 'url'
                }));
                const data = typeof result === 'string' ? JSON.parse(result) : result;
                log('å¡ç‰‡æ·»åŠ æˆåŠŸ:', 'success');
                log(data, 'info');
            } catch (e) {
                log(`æ·»åŠ å¡ç‰‡å¤±è´¥: ${e.message}`, 'error');
            }
        }

        let lastCardId = null;

        async function testDeleteLastCard() {
            log('è°ƒç”¨: Memento.plugins.webview.getCards() ç„¶ååˆ é™¤æœ€åä¸€å¼ ', 'info');
            try {
                // å…ˆè·å–æ‰€æœ‰å¡ç‰‡
                const cardsResult = await callMemento(() => Memento.plugins.webview.getCards());
                const cards = typeof cardsResult === 'string' ? JSON.parse(cardsResult) : cardsResult;

                if (!Array.isArray(cards) || cards.length === 0) {
                    log('æ²¡æœ‰å¯åˆ é™¤çš„å¡ç‰‡', 'warn');
                    return;
                }

                const lastCard = cards[cards.length - 1];
                log(`åˆ é™¤å¡ç‰‡: ${lastCard.title} (${lastCard.id})`, 'info');

                const result = await callMemento(() => Memento.plugins.webview.deleteCard({
                    cardId: lastCard.id
                }));

                log('å¡ç‰‡åˆ é™¤æˆåŠŸ', 'success');
            } catch (e) {
                log(`åˆ é™¤å¡ç‰‡å¤±è´¥: ${e.message}`, 'error');
            }
        }

        // ==================== å…¶ä»–æ’ä»¶ ====================

        const plugins = [
            { id: 'diary', name: 'æ—¥è®°', icon: 'ğŸ“”', method: 'getEntries', params: { limit: 5 } },
            { id: 'notes', name: 'ç¬”è®°', icon: 'ğŸ“', method: 'getNotes', params: {} },
            { id: 'todo', name: 'ä»»åŠ¡', icon: 'âœ…', method: 'getTasks', params: {} },
            { id: 'activity', name: 'æ´»åŠ¨', icon: 'â±ï¸', method: 'getActivities', params: { limit: 5 } },
            { id: 'checkin', name: 'ç­¾åˆ°', icon: 'ğŸ“…', method: 'getItems', params: {} },
            { id: 'bill', name: 'è´¦å•', icon: 'ğŸ’°', method: 'getRecords', params: { limit: 5 } },
            { id: 'goods', name: 'ç‰©å“', icon: 'ğŸ“¦', method: 'getItems', params: {} },
            { id: 'habits', name: 'ä¹ æƒ¯', icon: 'ğŸ¯', method: 'getHabits', params: {} },
            { id: 'tracker', name: 'è¿½è¸ª', icon: 'ğŸ“Š', method: 'getGoals', params: {} },
            { id: 'contact', name: 'è”ç³»äºº', icon: 'ğŸ‘¤', method: 'getContacts', params: {} },
            { id: 'chat', name: 'èŠå¤©', icon: 'ğŸ’¬', method: 'getChannels', params: {} },
            { id: 'openai', name: 'AI', icon: 'ğŸ¤–', method: 'getAssistants', params: {} },
        ];

        function renderPluginGrid() {
            const grid = document.getElementById('pluginGrid');
            grid.innerHTML = plugins.map(p => `
                <div class="plugin-card" onclick="testPlugin('${p.id}', '${p.method}', ${JSON.stringify(JSON.stringify(p.params))})">
                    <div class="icon">${p.icon}</div>
                    <div class="name">${p.name}</div>
                </div>
            `).join('');
        }

        async function testPlugin(pluginId, method, paramsStr) {
            const params = JSON.parse(paramsStr);
            log(`è°ƒç”¨: Memento.plugins.${pluginId}.${method}(${JSON.stringify(params)})`, 'info');
            try {
                const result = await callMemento(() => Memento.plugins[pluginId][method](params));
                const data = typeof result === 'string' ? JSON.parse(result) : result;
                log(`${pluginId}.${method} è¿”å›:`, 'success');
                log(data, 'info');
            } catch (e) {
                log(`è°ƒç”¨å¤±è´¥: ${e.message}`, 'error');
            }
        }

        // ==================== è‡ªå®šä¹‰è°ƒç”¨ ====================

        async function testCustomCall() {
            const pluginId = document.getElementById('customPluginId').value;
            const method = document.getElementById('customMethod').value;
            const paramsStr = document.getElementById('customParams').value;

            let params = {};
            try {
                if (paramsStr.trim()) {
                    params = JSON.parse(paramsStr);
                }
            } catch (e) {
                log(`å‚æ•° JSON è§£æå¤±è´¥: ${e.message}`, 'error');
                return;
            }

            log(`è°ƒç”¨: Memento.plugins.${pluginId}.${method}(${JSON.stringify(params)})`, 'info');
            try {
                const result = await callMemento(() => Memento.plugins[pluginId][method](params));
                const data = typeof result === 'string' ? JSON.parse(result) : result;
                log('è¿”å›ç»“æœ:', 'success');
                log(data, 'info');
            } catch (e) {
                log(`è°ƒç”¨å¤±è´¥: ${e.message}`, 'error');
            }
        }

        // ==================== åˆå§‹åŒ– ====================

        window.onload = function() {
            log('æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            renderPluginGrid();

            // å»¶è¿Ÿæ£€æµ‹ Bridgeï¼ˆç­‰å¾…æ³¨å…¥å®Œæˆï¼‰
            setTimeout(checkBridge, 500);
        };

        // ç›‘å¬ Bridge æ³¨å…¥
        if (typeof window.flutter_inappwebview !== 'undefined') {
            window.flutter_inappwebview.callHandler('Memento_ready').then(() => {
                log('æ”¶åˆ° Memento Bridge å°±ç»ªä¿¡å·', 'success');
                checkBridge();
            }).catch(() => {});
        }
    </script>
</body>
</html>
