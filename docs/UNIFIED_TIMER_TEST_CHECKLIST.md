# 统一计时器控制器 - 测试验证清单

## 测试环境准备

### 前置条件
- [ ] Android设备或模拟器（API Level 26+）
- [ ] Flutter开发环境已配置
- [ ] 项目依赖已安装（`flutter pub get`）

### 构建应用
```bash
# 构建Android APK
flutter build apk --debug

# 安装到设备
flutter install
```

---

## 第一阶段：核心功能测试

### 1.1 统一控制器基础功能

#### 测试用例 1.1.1：单计时器启动
**操作步骤**：
1. 打开Todo插件
2. 创建一个新任务
3. 点击任务详情页的"开始计时"按钮

**预期结果**：
- [ ] 任务状态变为"进行中"
- [ ] 计时器开始计时（00:00:01, 00:00:02...）
- [ ] 通知栏出现计时器通知

**验证点**：
- 计时器UI实时更新
- 通知栏显示任务名称
- 通知栏进度条从0开始

---

#### 测试用例 1.1.2：单计时恢复
**操作器暂停/步骤**：
1. 等待计时器运行5秒
2. 点击"暂停"按钮
3. 等待3秒
4. 点击"恢复"按钮

**预期结果**：
- [ ] 暂停时计时器停止更新
- [ ] 恢复后从暂停时的时间继续计时
- [ ] 通知栏显示"已暂停"状态

**验证点**：
- elapsed时间累加正确
- 状态转换正确（running -> paused -> running）

---

#### 测试用例 1.1.3：单计时器停止
**操作步骤**：
1. 运行计时器10秒
2. 点击"停止"或"完成"按钮

**预期结果**：
- [ ] 计时器停止
- [ ] 任务状态变为"已完成"（如适用）
- [ ] 通知栏通知消失
- [ ] 累计时长正确显示

**验证点**：
- 总时长计算正确
- 状态转换为stopped

---

### 1.2 统一控制器多实例支持

#### 测试用例 1.2.1：两个计时器并行
**操作步骤**：
1. 打开Todo插件，启动任务A计时器
2. 打开Tracker插件，启动目标B计时器
3. 等待5秒

**预期结果**：
- [ ] 两个通知栏同时显示
- [ ] 各自独立计时（00:00:05）
- [ ] UI分别更新各自状态

**验证点**：
- 通知栏ID不冲突
- 两个计时器独立运行
- 事件系统正确广播用例 1.

---

#### 测试2.2：四个计时器并行
**操作步骤**：
1. 启动Todo任务计时器
2. 启动Tracker目标计时器
3. 启动Habits习惯计时器
4. 启动Timer插件计时器

**预期结果**：
- [ ] 4个通知栏同时显示
- [ ] 每个通知栏独立ID（10000-99999范围）
- [ ] 所有计时器正常运行

**验证点**：
- 通知栏数量 = 4
- 通知栏样式各异（不同颜色/图标）
- 无性能问题（CPU < 20%）

---

#### 测试用例 1.2.3：跨插件状态同步
**操作步骤**：
1. 启动Todo任务计时器
2. 切换到其他插件
3. 等待10秒
4. 切换回Todo插件

**预期结果**：
- [ ] 计时器仍在运行
- [ ] 显示正确的时间（10+秒）
- [ ] UI状态与通知栏一致

**验证点**：
- 应用切换不影响计时器
- 状态持久化正确

---

### 1.3 事件系统测试

#### 测试用例 1.3.1：统一事件广播
**操作步骤**：
1. 启动一个计时器
2. 监听事件：`eventManager.subscribe('unified_timer_updated', ...)`

**预期结果**：
- [ ] 每秒收到更新事件
- [ ] 事件参数包含正确状态（id, status, elapsed）
- [ ] 事件时间戳正确

**验证点**：
- 事件频率 = 1秒/次
- 数据完整性
- 无内存泄漏

---

#### 测试用例 1.3.2：插件专用事件转换
**操作步骤**：
1. 在Habits插件中启动习惯计时器
2. 监听habit_timer_started事件

**预期结果**：
- [ ] 收到habit_timer_started事件
- [ ] 参数格式正确（HabitTimerEventArgs）
- [ ] 与统一事件数据一致

**验证点**：
- 事件名称正确
- 数据转换正确

---

## 第二阶段：插件专项测试

### 2.1 Todo插件测试

#### 测试用例 2.1.1：任务计时器
**操作步骤**：
1. 创建任务"测试任务"
2. 进入任务详情
3. 点击"开始"按钮

**预期结果**：
- [ ] 状态切换为"进行中"
- [ ] 计时器开始
- [ ] 显示格式化时长（HH:MM:SS）
- [ ] 通知栏显示"测试任务"

**验证点**：
- startTimer委托调用正确
- 状态字段同步
- 通知栏内容正确

---

#### 测试用例 2.1.2：任务完成
**操作步骤**：
1. 运行任务计时器10秒
2. 点击"完成"按钮

**预期结果**：
- [ ] 计时器停止
- [ ] 状态切换为"已完成"
- [ ] duration字段更新
- [ ] 通知栏消失

**验证点**：
- completeTask委托调用正确
- duration计算正确

---

### 2.2 Tracker插件测试

#### 测试用例 2.2.1：目标计时器
**操作步骤**：
1. 创建目标"每日阅读30分钟"
2. 点击目标卡片的计时器按钮
3. 在弹窗中点击"开始"

**预期结果**：
- [ ] 计时器对话框开始计时
- [ ] 状态栏显示计时器运行中
- [ ] 通知栏显示目标名称

**验证点**：
- TimerDialog集成正确
- 事件订阅工作正常
- 状态同步正确

---

#### 测试用例 2.2.2：目标记录
**操作步骤**：
1. 运行目标计时器5分钟
2. 点击"保存"

**预期结果**：
- [ ] 创建新记录
- [ ] 目标当前值增加
- [ ] 记录包含durationSeconds

**验证点**：
- 记录创建正确
- 目标值更新正确

---

### 2.3 Habits插件测试

#### 测试用例 2.3.1：习惯计时器
**操作步骤**：
1. 创建习惯"晨跑"
2. 进入习惯详情
3. 点击计时器按钮
4. 选择"开始计时"

**预期结果**：
- [ ] 计时器启动
- [ ] 卡片显示计时状态
- [ ] 通知栏显示

**验证点**：
- TimerController委托模式工作
- 卡片状态更新
- 事件监听正确

---

#### 测试用例 2.3.2：倒计时模式
**操作步骤**：
1. 设置习惯时长30分钟
2. 启动倒计时

**预期结果**：
- [ ] 从30:00倒计时
- [ ] 到00:00时自动停止
- [ ] 显示"已完成"

**验证点**：
- 倒计时逻辑正确
- 自动完成机制

---

### 2.4 Timer插件测试

#### 测试用例 2.4.1：多阶段计时器
**操作步骤**：
1. 创建多阶段计时器（工作25分钟，休息5分钟）
2. 启动计时器

**预期结果**：
- [ ] 第一阶段开始（工作25分钟）
- [ ] 阶段切换正确（工作→休息→工作）
- [ ] 通知栏显示当前阶段

**验证点**：
- 多阶段管理正确
- 阶段切换事件
- 通知栏更新正确

---

#### 测试用例 2.4.2：番茄钟模式
**操作步骤**：
1. 启用番茄钟模式
2. 设置工作/休息时长
3. 启动

**预期结果**：
- [ ] 自动循环工作/休息
- [ ] 通知栏显示阶段名称
- [ ] 达到循环次数后停止

**验证点**：
- 番茄钟逻辑正确
- 自动循环机制

---

## 第三阶段：通知栏专项测试

### 3.1 通知栏显示测试

#### 测试用例 3.1.1：通知内容正确性
**操作步骤**：
1. 启动一个计时器
2. 检查通知栏

**预期结果**：
- [ ] 标题显示计时器名称
- [ ] 内容显示当前时间
- [ ] 进度条显示进度
- [ ] 小图标正确

**验证点**：
- 标题/内容格式
- 进度条范围（0-100）
- 图标资源

---

#### 测试用例 3.1.2：主题色显示
**操作步骤**：
1. 启动不同插件的计时器
2. 检查通知栏颜色

**预期结果**：
- [ ] Todo插件：蓝色
- [ ] Tracker插件：橙色
- [ ] Habits插件：绿色
- [ ] Timer插件：默认色

**验证点**：
- 颜色值正确传递
- 通知栏显示颜色

---

#### 测试用例 3.1.3：点击通知行为
**操作步骤**：
1. 启动计时器
2. 点击通知栏通知

**预期结果**：
- [ ] 打开应用
- [ ] 跳转到对应插件
- [ ] 高亮显示对应的计时器

**验证点**：
- PendingIntent正确
- 导航逻辑正确

---

### 3.2 通知栏管理测试

#### 测试用例 3.2.1：通知栏数量上限
**操作步骤**：
1. 连续启动20个计时器
2. 检查通知栏

**预期结果**：
- [ ] 前20个显示正常
- [ ] 超过20个时早期通知被替换（根据Android策略）

**验证点**：
- ID生成无冲突
- 管理机制正确

---

#### 测试用例 3.2.2：停止后通知清理
**操作步骤**：
1. 启动5个计时器
2. 逐个停止
3. 检查通知栏

**预期结果**：
- [ ] 停止1个，通知栏减少1个
- [ ] 全部停止后，通知栏清空
- [ ] ID可重用

**验证点**：
- 通知清理及时
- ID管理正确

---

## 第四阶段：性能与稳定性测试

### 4.1 性能测试

#### 测试用例 4.1.1：多计时器性能
**操作步骤**：
1. 启动10个计时器
2. 运行30分钟
3. 监控CPU/内存

**预期结果**：
- [ ] CPU使用率 < 20%
- [ ] 内存增长 < 50MB
- [ ] 无卡顿现象

**验证点**：
- 单Timer更新机制有效
- 无内存泄漏
- UI流畅度

---

#### 测试用例 4.1.2：长时间运行稳定性
**操作步骤**：
1. 启动5个计时器
2. 运行24小时

**预期结果**：
- [ ] 所有计时器正常运行
- [ ] 累计时间准确
- [ ] 无崩溃现象

**验证点**：
- 时间计算精确
- 内存稳定
- 系统稳定性

---

### 4.2 边界情况测试

#### 测试用例 4.2.1：应用重启后恢复
**操作步骤**：
1. 启动3个计时器
2. 运行5分钟
3. 强制关闭应用
4. 重新打开应用

**预期结果**：
- [ ] 计时器状态丢失（当前实现）
- [ ] 应用正常启动

**验证点**：
- 无数据丢失错误
- 应用启动正常

**备注**：状态持久化将在未来版本实现

---

#### 测试用例 4.2.2：并发操作
**操作步骤**：
1. 快速启动/停止同一个计时器
2. 快速切换状态

**预期结果**：
- [ ] 无状态混乱
- [ ] 无异常抛出
- [ ] 最终状态正确

**验证点**：
- 状态机正确
- 线程安全

---

#### 测试用例 4.2.3：无效输入处理
**操作步骤**：
1. 调用startTimer时传入null参数
2. 调用stopTimer时传入不存在的ID

**预期结果**：
- [ ] 抛出明确错误
- [ ] 应用不崩溃
- [ ] 日志记录错误

**验证点**：
- 参数验证正确
- 错误处理健壮

---

## 第五阶段：兼容性测试

### 5.1 向下兼容性

#### 测试用例 5.1.1：旧版API调用
**操作步骤**：
1. 使用旧版API `startTimerService()`
2. 检查功能

**预期结果**：
- [ ] 功能正常（向后兼容）
- [ ] 显示警告日志（deprecated）

**验证点**：
- API兼容性
- 警告提示正确

---

### 5.2 插件升级兼容性

#### 测试用例 5.2.1：旧数据迁移
**操作步骤**：
1. 使用旧版本创建一些计时器数据
2. 升级到新版本
3. 检查数据

**预期结果**：
- [ ] 旧数据正常读取
- [ ] 不影响新功能

**验证点**：
- 数据格式兼容
- 迁移逻辑正确

---

## 测试报告模板

### 测试执行记录

| 测试用例ID | 测试用例名称 | 执行状态 | 结果 | 备注 |
|-----------|-------------|---------|------|------|
| 1.1.1 | 单计时器启动 | ✅ 通过 | - | - |
| 1.1.2 | 单计时器暂停/恢复 | ✅ 通过 | - | - |
| 1.2.1 | 两个计时器并行 | ✅ 通过 | - | - |
| ... | ... | ... | ... | ... |

### 性能指标记录

| 计时器数量 | CPU使用率 | 内存使用 | UI流畅度 |
|-----------|----------|----------|----------|
| 1 | 5% | +10MB | 流畅 |
| 5 | 10% | +25MB | 流畅 |
| 10 | 18% | +45MB | 流畅 |
| 20 | 25% | +80MB | 轻微卡顿 |

### 问题记录

| 问题ID | 问题描述 | 严重程度 | 状态 | 解决方案 |
|-------|---------|---------|------|----------|
| BUG-001 | 通知栏颜色不正确 | 中 | 已修复 | 修复color参数传递 |
| BUG-002 | 长时间运行后内存增长 | 低 | 调查中 | 检查内存泄漏 |

---

## 测试工具推荐

### 手动测试工具
- **Android Studio Profiler**：监控CPU/内存
- **adb logcat**：查看日志
- **通知栏调试器**：检查通知栏状态

### 自动化测试（未来）
```dart
// 示例：单元测试
test('UnifiedTimerController: startTimer', () {
  final controller = UnifiedTimerController();
  controller.startTimer(id: 'test', name: 'Test', ...);
  expect(controller.getTimer('test')?.status, TimerStatus.running);
});

// 示例：集成测试
testWidgets('TimerDialog: start timer', (tester) async {
  await tester.pumpWidget(...);
  await tester.tap(find.byIcon(Icons.play_arrow));
  await tester.pump();
  expect(find.text('00:00:01'), findsOneWidget);
});
```

---

## 验收标准

### 必须通过（Must Have）
- [ ] 4个插件的计时器统一到同一个控制器
- [ ] 支持至少10个计时器并行运行
- [ ] 通知栏正确显示多计时器
- [ ] 所有核心API正常工作
- [ ] 无崩溃或严重错误

### 期望通过（Should Have）
- [ ] 性能指标符合要求（CPU<20%, 内存增长<50MB）
- [ ] 事件系统正常工作
- [ ] 状态同步正确
- [ ] 通知栏样式正确

### 可选通过（Could Have）
- [ ] 长时间运行稳定性（24小时+）
- [ ] 状态持久化（应用重启后恢复）
- [ ] 性能优化效果显著
- [ ] 自动化测试覆盖

---

## 测试完成标准

当所有"必须通过"项目完成，且"期望通过"项目完成度≥80%时，认为测试通过。

**测试负责人签字**：________________

**测试日期**：________________
