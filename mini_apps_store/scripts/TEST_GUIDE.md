# 脚本中心多文件夹功能测试指南

## 测试环境
- 测试日期：2025-11-15
- 修改内容：
  1. 添加多文件夹支持
  2. 修复事件数据序列化问题

---

## 测试步骤

### 1. 验证文件夹功能

#### 1.1 启动应用
```bash
flutter run
```

#### 1.2 打开脚本中心
1. 在主界面找到"脚本中心"插件
2. 点击进入

#### 1.3 检查默认文件夹
应该看到两个默认文件夹：
- ✅ **我的脚本** (默认选中)
- ✅ **示例脚本**

#### 1.4 切换文件夹
1. 点击顶部 AppBar 的"文件夹"图标
2. 应该看到下拉菜单显示两个文件夹
3. 切换到"示例脚本"文件夹
4. 应该看到标题变为"脚本中心 / 示例脚本"

#### 1.5 查看示例脚本
在"示例脚本"文件夹中，应该看到：
- **事件处理示例** (example_event_handler)
  - 图标：event
  - 状态：默认禁用
  - 描述：演示如何在脚本中访问和处理事件数据

---

### 2. 验证事件数据序列化修复

#### 2.1 启用示例脚本
1. 在"示例脚本"文件夹中找到"事件处理示例"
2. 点击脚本卡片，进入编辑界面
3. 将"启用"开关打开
4. 保存脚本

#### 2.2 触发测试事件
以日记插件为例：
1. 打开"日记"插件
2. 创建一条新日记
3. 标题：`测试事件触发`
4. 保存日记

#### 2.3 检查控制台日志
应该看到类似输出：
```
🎯 触发事件: diary_entry_added -> 执行脚本: 事件处理示例
=== 事件触发 ===
事件名称: diary_entry_added
📝 新日记已添加
  标题: 测试事件触发
  ID: <日记ID>
  时间: <当前时间>
✅ 脚本执行成功: 事件处理示例
   耗时: <执行时间>ms
```

**关键点**：
- ✅ 不应该再出现 "Converting object to an encodable object failed" 错误
- ✅ 事件数据应该正确传递到脚本
- ✅ 脚本应该能访问 `args.eventData` 中的所有字段

---

### 3. 验证深度序列化

#### 3.1 测试包含复杂对象的事件
某些事件可能包含 Message、Channel、User 等复杂对象。

测试聊天消息事件：
1. 修改示例脚本，添加对聊天事件的监听：
```javascript
// 在 metadata.json 的 triggers 中添加：
{
  "event": "chat_message_sent",
  "delay": 0
}
```

2. 在聊天插件中发送一条消息

3. 检查脚本是否能正确接收和处理事件数据

#### 3.2 预期行为
- ✅ 所有嵌套对象（Message、User、Channel）都应该被正确序列化为 JSON
- ✅ 异步 toJson 方法应该被正确等待
- ✅ 脚本中可以访问完整的对象数据

---

## 已知问题与解决方案

### 问题 1: "Converting object to an encodable object failed"
**原因**: EventArgs 中包含未序列化的复杂对象（如 Message 实例）

**解决方案**:
- ✅ 已实现 `_deepSerializeAsync` 函数
- ✅ 递归处理所有嵌套对象
- ✅ 支持异步 toJson 方法
- ✅ 自动调用对象的 toJson 方法

### 问题 2: 内置示例脚本无法加载
**原因**: assets 路径未配置

**解决方案**:
- ✅ 已在 pubspec.yaml 中添加：
  ```yaml
  assets:
    - lib/plugins/scripts_center/examples/
  ```

### 问题 3: 文件夹为空
**原因**: ScriptLoader 未正确扫描指定文件夹

**解决方案**:
- ✅ 已实现 `scanScriptsInFolder` 方法
- ✅ 支持从 assets 加载内置脚本
- ✅ 支持从文件系统加载用户脚本

---

## 回归测试

### 基本功能
- [ ] 创建新脚本
- [ ] 编辑现有脚本
- [ ] 删除脚本
- [ ] 启用/禁用脚本
- [ ] 手动运行脚本（带参数）
- [ ] 事件触发器自动执行

### 文件夹功能
- [ ] 查看"我的脚本"文件夹
- [ ] 查看"示例脚本"文件夹
- [ ] 切换文件夹
- [ ] 在不同文件夹中创建脚本

### 事件功能
- [ ] 日记事件触发
- [ ] TODO 事件触发
- [ ] 聊天事件触发
- [ ] 日历事件触发
- [ ] 多个触发器同时工作

---

## 性能测试

### 序列化性能
测试大量消息的序列化：
```javascript
// 在脚本中记录执行时间
const startTime = Date.now();
// ... 处理事件数据
const endTime = Date.now();
console.log(`处理耗时: ${endTime - startTime}ms`);
```

**预期**:
- 简单事件（无嵌套对象）: < 5ms
- 复杂事件（包含 Message/Channel）: < 20ms
- 包含大型列表的事件: < 50ms

---

## 调试技巧

### 1. 查看完整事件数据
在脚本中添加：
```javascript
console.log('=== 事件数据调试 ===');
console.log(JSON.stringify(args.eventData, null, 2));
```

### 2. 检查序列化结果
在 `scripts_center_plugin.dart` 中添加调试日志：
```dart
final eventData = await _serializeEventArgsAsync(args);
print('序列化后的事件数据: ${jsonEncode(eventData)}');
```

### 3. 捕获序列化错误
修改 `_deepSerializeAsync` 添加详细错误日志：
```dart
} catch (e, stackTrace) {
  print('❌ 序列化失败: $e');
  print('堆栈: $stackTrace');
  print('值类型: ${value.runtimeType}');
}
```

---

## 成功标准

所有以下条件都应满足：

1. ✅ 应用正常启动，无崩溃
2. ✅ 脚本中心显示两个默认文件夹
3. ✅ 可以在文件夹之间切换
4. ✅ 示例脚本可以查看和编辑
5. ✅ 事件触发时不会出现序列化错误
6. ✅ 脚本可以正确访问 `args.eventData`
7. ✅ 包含复杂对象的事件可以正确处理
8. ✅ 所有现有功能正常工作（无回归）

---

**测试人员**: _____________
**测试日期**: _____________
**测试结果**: ⬜ 通过 ⬜ 失败
**备注**: _______________________________________________
