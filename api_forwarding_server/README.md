# Memento API è½¬å‘æœåŠ¡å™¨

ä¸€ä¸ª WebSocket ä»£ç†æœåŠ¡å™¨ï¼Œç”¨äºåœ¨ **Web å‰ç«¯** å’Œ **Flutter å®¢æˆ·ç«¯** ä¹‹é—´è½¬å‘ API è¯·æ±‚ï¼Œå®ç°å‰ç«¯é€šè¿‡ Memento å®¢æˆ·ç«¯è®¿é—®æ’ä»¶åŠŸèƒ½ã€‚

---

## ğŸ“‹ ç›®å½•

- [æ¶æ„æ¦‚è¿°](#æ¶æ„æ¦‚è¿°)
- [ä¸‰ç«¯è§’è‰²](#ä¸‰ç«¯è§’è‰²)
- [é€šä¿¡æµç¨‹](#é€šä¿¡æµç¨‹)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [è¯¦ç»†é…ç½®](#è¯¦ç»†é…ç½®)
- [æ¶ˆæ¯åè®®](#æ¶ˆæ¯åè®®)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## æ¶æ„æ¦‚è¿°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web å‰ç«¯      â”‚         â”‚  è½¬å‘æœåŠ¡å™¨       â”‚         â”‚  Flutter å®¢æˆ·ç«¯  â”‚
â”‚  (Frontend)     â”‚         â”‚  (8654 ç«¯å£)     â”‚         â”‚   (Client)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â”‚         â”‚                  â”‚         â”‚                 â”‚
â”‚ â€¢ React/Vue     â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚ â€¢ Memento App   â”‚
â”‚ â€¢ memento-mock  â”‚  WS     â”‚  â€¢ é…å¯¹ç®¡ç†       â”‚  WS     â”‚ â€¢ æ’ä»¶ç³»ç»Ÿ      â”‚
â”‚ â€¢ æµè§ˆå™¨        â”‚         â”‚  â€¢ æ¶ˆæ¯è·¯ç”±       â”‚         â”‚ â€¢ JSBridge API  â”‚
â”‚                 â”‚         â”‚  â€¢ å¿ƒè·³æ£€æµ‹       â”‚         â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          é…å¯¹å¯†é’¥: ABCD-1234-EFGH-5678
```

### æ ¸å¿ƒåŠŸèƒ½

- âœ… **é…å¯¹åŒ¹é…**ï¼šé€šè¿‡ç›¸åŒçš„é…å¯¹å¯†é’¥è¿æ¥å‰ç«¯å’Œå®¢æˆ·ç«¯
- âœ… **åŒå‘è½¬å‘**ï¼šå‰ç«¯çš„è¯·æ±‚ â†’ æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ â†’ å‰ç«¯çš„å“åº”
- âœ… **å¿ƒè·³æ£€æµ‹**ï¼šä¿æŒè¿æ¥æ´»è·ƒï¼Œæ£€æµ‹æ–­çº¿
- âœ… **ä¼šè¯ç®¡ç†**ï¼šç®¡ç†é…å¯¹åçš„ä¼šè¯çŠ¶æ€
- âœ… **è§’è‰²åˆ†ç¦»**ï¼šå‰ç«¯ï¼ˆ`frontend`ï¼‰å’Œå®¢æˆ·ç«¯ï¼ˆ`client`ï¼‰å„ä¸€ä¸ªï¼Œä¸ä¼šæ··æ·†

---

## ä¸‰ç«¯è§’è‰²

### 1ï¸âƒ£ è½¬å‘æœåŠ¡å™¨ï¼ˆä¸­é—´å±‚ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`api_forwarding_server/`

**èŒè´£**ï¼š
- ä½œä¸ºä¸­é—´äººï¼Œè¿æ¥ Web å‰ç«¯å’Œ Flutter å®¢æˆ·ç«¯
- ç®¡ç†é…å¯¹å’Œä¼šè¯
- è½¬å‘ API è¯·æ±‚å’Œå“åº”

**å¯åŠ¨å‘½ä»¤**ï¼š
```bash
cd api_forwarding_server
npm install
npm start    # é»˜è®¤ç«¯å£ 8654
```

**æ—¥å¿—ç¤ºä¾‹**ï¼š
```
[æœåŠ¡å™¨] ç›‘å¬ç«¯å£: 8654
[ä¼šè¯] è®¤è¯è¯·æ±‚: frontend, key: ABCD-1234-EFGH-5678
[ä¼šè¯] æ–°ä¼šè¯åˆ›å»º: xxx-xxx-xxx
[ä¼šè¯] xxx: è½¬å‘è¯·æ±‚ msg_123 -> bill.getAccounts
[ä¼šè¯] xxx: è½¬å‘å“åº” msg_123 -> æˆåŠŸ
```

---

### 2ï¸âƒ£ Flutter å®¢æˆ·ç«¯ï¼ˆæ•°æ®å±‚ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼š`lib/core/api_forwarding/`

**èŒè´£**ï¼š
- æä¾› Memento æ’ä»¶çš„ JSBridge API
- å¤„ç†æ¥è‡ªå‰ç«¯çš„ API è¯·æ±‚
- è¿”å›çœŸå®çš„æ’ä»¶æ•°æ®

**é…ç½®æ–¹å¼**ï¼š
1. æ‰“å¼€ Memento åº”ç”¨
2. è¿›å…¥ **è®¾ç½® > å¼€å‘è€…æµ‹è¯• > è½¬å‘æ•°æ®æœåŠ¡**
3. å¡«å†™é…ç½®ï¼š
   - æœåŠ¡å™¨åœ°å€ï¼š`ws://localhost:8654`
   - é…å¯¹å¯†é’¥ï¼š`ABCD-1234-EFGH-5678`
   - è®¾å¤‡åç§°ï¼š`Memento Client`
   - âœ… å¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥ï¼ˆå¯é€‰ï¼‰
4. ç‚¹å‡»"è¿æ¥"

**å®¢æˆ·ç«¯çŠ¶æ€**ï¼š
- ğŸŸ  **æœªè¿æ¥**ï¼šæ©™è‰²æç¤ºï¼Œéœ€è¦ç‚¹å‡»è¿æ¥
- ğŸ”µ **ç­‰å¾…å‰ç«¯è¿æ¥...**ï¼šè“è‰²æç¤ºï¼Œç­‰å¾… Web å‰ç«¯è¿æ¥
- ğŸŸ¢ **å·²è¿æ¥åˆ°å‰ç«¯**ï¼šç»¿è‰²æç¤ºï¼Œé…å¯¹æˆåŠŸ

**æ—¥å¿—ç¤ºä¾‹**ï¼š
```
[APIè½¬å‘] æ­£åœ¨è¿æ¥åˆ° ws://localhost:8654...
[APIè½¬å‘] è®¤è¯æˆåŠŸï¼Œå·²åŒ¹é…å¯¹ç«¯
[APIè½¬å‘] æ”¶åˆ°æ¶ˆæ¯: request, æ•°æ®: {...}
[APIè½¬å‘] è°ƒç”¨: bill.getAccounts
[APIè½¬å‘] è°ƒç”¨æˆåŠŸï¼Œç»“æœ: [...]
[APIè½¬å‘] å‘é€å“åº”: {...}
```

---

### 3ï¸âƒ£ Web å‰ç«¯ï¼ˆè°ƒç”¨å±‚ï¼‰

**æ–‡ä»¶ä½ç½®**ï¼šå‰ç«¯é¡¹ç›®æ ¹ç›®å½•çš„ `memento-config.ts` å’Œ `index.tsx`

**èŒè´£**ï¼š
- æä¾›ç”¨æˆ·ç•Œé¢
- é€šè¿‡ `Memento.plugins.*.*` è°ƒç”¨ API
- æ¥æ”¶å¹¶æ˜¾ç¤ºè¿”å›çš„æ•°æ®

**é…ç½®æ–¹å¼**ï¼š

1. **åˆ›å»ºé…ç½®æ–‡ä»¶** (`memento-config.ts`)ï¼š
```typescript
export const mementoConfig = {
  enabled: true,                      // å¯ç”¨è½¬å‘æ¨¡å¼
  serverUrl: 'ws://localhost:8654',  // æœåŠ¡å™¨åœ°å€
  pairingKey: 'ABCD-1234-EFGH-5678', // é…å¯¹å¯†é’¥ï¼ˆä¸å®¢æˆ·ç«¯ç›¸åŒï¼‰
  timeout: 0,                         // 0 = æ— è¶…æ—¶
};
```

2. **åˆå§‹åŒ–** (`index.tsx`)ï¼š
```typescript
import('memento-mock').then((module) => {
  module.default({
    enableForwarding: mementoConfig.enabled,
    serverUrl: mementoConfig.serverUrl,
    pairingKey: mementoConfig.pairingKey,
    timeout: mementoConfig.timeout,
  });
});
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```javascript
// è·å–è´¦å•è´¦æˆ·
let accounts = await Memento.plugins.bill.getAccounts({});
console.log('è´¦æˆ·åˆ—è¡¨:', accounts);

// è·å– Todo åˆ—è¡¨
let todos = await Memento.plugins.todo.getItems({ count: 10 });
console.log('å¾…åŠäº‹é¡¹:', todos);

// è·å–æ—¥è®°æ¡ç›®
let diaries = await Memento.plugins.diary.getEntries({ limit: 5 });
console.log('æ—¥è®°åˆ—è¡¨:', diaries);
```

**æ—¥å¿—ç¤ºä¾‹**ï¼š
```
[Memento Mock] å¯ç”¨è½¬å‘æ¨¡å¼
[WebSocket] æ­£åœ¨è¿æ¥åˆ° ws://localhost:8654...
[WebSocket] è¿æ¥å·²å»ºç«‹ï¼Œæ­£åœ¨è®¤è¯...
[WebSocket] è®¤è¯æˆåŠŸï¼Œå·²åŒ¹é…å¯¹ç«¯
[WebSocket] è°ƒç”¨: bill.getAccounts
[WebSocket] æ”¶åˆ° API å“åº”: {...}
[WebSocket] API è°ƒç”¨æˆåŠŸï¼Œç»“æœ: [...]
```

---

## é€šä¿¡æµç¨‹

### å®Œæ•´è¯·æ±‚æµç¨‹

```
1. å‰ç«¯å‘èµ·è°ƒç”¨
   â””â”€> Memento.plugins.bill.getAccounts({})
       â””â”€> WebSocketClient.callPlugin()

2. å‰ç«¯å‘é€è¯·æ±‚æ¶ˆæ¯
   â””â”€> WebSocket æœåŠ¡å™¨
       {
         "type": "request",
         "requestId": "msg_123",
         "pluginId": "bill",
         "methodName": "getAccounts",
         "params": {}
       }

3. æœåŠ¡å™¨è½¬å‘ç»™å®¢æˆ·ç«¯
   â””â”€> æŸ¥æ‰¾é…å¯¹ä¼šè¯
   â””â”€> å‘é€ç»™ Flutter å®¢æˆ·ç«¯

4. å®¢æˆ·ç«¯å¤„ç†è¯·æ±‚
   â””â”€> ApiForwardingService æ”¶åˆ°æ¶ˆæ¯
   â””â”€> è°ƒç”¨ JSBridgeManager
   â””â”€> æ‰§è¡Œ bill.getAccounts()
   â””â”€> è·å¾—ç»“æœ

5. å®¢æˆ·ç«¯å‘é€å“åº”
   â””â”€> WebSocket æœåŠ¡å™¨
       {
         "type": "response",
         "requestId": "msg_123",
         "success": true,
         "result": [...]
       }

6. æœåŠ¡å™¨è½¬å‘ç»™å‰ç«¯
   â””â”€> æŸ¥æ‰¾é…å¯¹ä¼šè¯
   â””â”€> å‘é€ç»™ Web å‰ç«¯

7. å‰ç«¯æ¥æ”¶å“åº”
   â””â”€> WebSocketClient å¤„ç†å“åº”
   â””â”€> resolve Promise
   â””â”€> è¿”å›ç»™è°ƒç”¨è€…
```

### æ—¶åºå›¾

```
å‰ç«¯          æœåŠ¡å™¨           å®¢æˆ·ç«¯
 â”‚             â”‚                â”‚
 â”‚â”€â”€ è¿æ¥ â”€â”€â”€â”€â–ºâ”‚                â”‚
 â”‚             â”‚â”€â”€ ç­‰å¾…é…å¯¹ â”€â”€â”€â”€â–ºâ”‚
 â”‚             â”‚                â”‚
 â”‚â—„â”€ è®¤è¯æˆåŠŸ â”€â”€â”¤                â”‚
 â”‚             â”‚                â”‚
 â”‚â”€â”€ è¯·æ±‚ â”€â”€â”€â”€â–ºâ”‚â”€â”€ è½¬å‘è¯·æ±‚ â”€â”€â”€â”€â–ºâ”‚
 â”‚             â”‚                â”‚
 â”‚             â”‚                â”‚â”€â”€ æ‰§è¡Œ API â”€â”€
 â”‚             â”‚                â”‚
 â”‚             â”‚â—„â”€â”€ å“åº” â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚â—„â”€ å“åº” â”€â”€â”€â”€â–ºâ”‚                â”‚
 â”‚             â”‚                â”‚
```

---

## å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨æœåŠ¡å™¨

```bash
cd api_forwarding_server
npm install
npm start
```

è¾“å‡ºï¼š
```
[æœåŠ¡å™¨] ç›‘å¬ç«¯å£: 8654
```

### ç¬¬äºŒæ­¥ï¼šå¯åŠ¨ Flutter å®¢æˆ·ç«¯

1. æ‰“å¼€ Memento åº”ç”¨
2. è¿›å…¥ **è®¾ç½® > å¼€å‘è€…æµ‹è¯• > è½¬å‘æ•°æ®æœåŠ¡**
3. é…ç½®å¹¶ç‚¹å‡»"è¿æ¥"

ç­‰å¾…çŠ¶æ€æ˜¾ç¤ºï¼šğŸ”µ **ç­‰å¾…å‰ç«¯è¿æ¥...**

### ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨ Web å‰ç«¯

```bash
cd your-frontend-project
npm run dev
```

æµè§ˆå™¨æ§åˆ¶å°è¾“å‡ºï¼š
```
[Memento Mock] å¯åŠ¨è½¬å‘æ¨¡å¼
[WebSocket] è®¤è¯æˆåŠŸï¼Œå·²åŒ¹é…å¯¹ç«¯
```

Flutter å®¢æˆ·ç«¯çŠ¶æ€å˜ä¸ºï¼šğŸŸ¢ **å·²è¿æ¥åˆ°å‰ç«¯**

### ç¬¬å››æ­¥ï¼šæµ‹è¯•è¿æ¥

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// æµ‹è¯• 1: è·å–è´¦æˆ·åˆ—è¡¨
let accounts = await Memento.plugins.bill.getAccounts({});
console.log('è´¦æˆ·:', accounts);

// æµ‹è¯• 2: è·å–å¾…åŠäº‹é¡¹
let todos = await Memento.plugins.todo.getItems({ count: 5 });
console.log('å¾…åŠ:', todos);

// æµ‹è¯• 3: è·å–æ—¥è®°
let diaries = await Memento.plugins.diary.getEntries({ limit: 3 });
console.log('æ—¥è®°:', diaries);
```

æˆåŠŸçš„è¯ä¼šè¿”å›çœŸå®æ•°æ®ï¼

---

## è¯¦ç»†é…ç½®

### æœåŠ¡å™¨é…ç½®

**ç¯å¢ƒå˜é‡**ï¼š
- `PORT` - æœåŠ¡å™¨ç«¯å£ï¼ˆé»˜è®¤ï¼š8654ï¼‰

**å¯åŠ¨å‚æ•°**ï¼š
```bash
# é»˜è®¤ç«¯å£ 8654
npm start

# è‡ªå®šä¹‰ç«¯å£
PORT=3000 npm start
```

### Flutter å®¢æˆ·ç«¯é…ç½®

**é…ç½®é¡¹**ï¼š

| é…ç½®é¡¹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| æœåŠ¡å™¨åœ°å€ | WebSocket æœåŠ¡å™¨åœ°å€ | `ws://localhost:8654` |
| é…å¯¹å¯†é’¥ | ç”¨äºåŒ¹é…å‰ç«¯å’Œå®¢æˆ·ç«¯ | `ABCD-1234-EFGH-5678` |
| è®¾å¤‡åç§° | å®¢æˆ·ç«¯æ ‡è¯† | `Memento Client` |
| å¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥ | åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥æœåŠ¡å™¨ | å¼€å…³ |

**å­˜å‚¨ä½ç½®**ï¼š
- SharedPreferencesï¼ˆAndroid/iOSï¼‰
- é…ç½®é”®ï¼š`api_forwarding_*`

### Web å‰ç«¯é…ç½®

**é…ç½®æ–‡ä»¶** (`memento-config.ts`)ï¼š

```typescript
export const mementoConfig = {
  // æ˜¯å¦å¯ç”¨è½¬å‘æ¨¡å¼
  enabled: true,

  // æœåŠ¡å™¨åœ°å€
  serverUrl: 'ws://localhost:8654',

  // é…å¯¹å¯†é’¥ï¼ˆä¸å®¢æˆ·ç«¯ä¸€è‡´ï¼‰
  pairingKey: 'ABCD-1234-EFGH-5678',

  // è¯·æ±‚è¶…æ—¶ï¼ˆæ¯«ç§’ï¼Œ0 = æ— è¶…æ—¶ï¼‰
  timeout: 0,
};
```

**åˆå§‹åŒ–ä»£ç ** (`index.tsx`)ï¼š

```typescript
import { mementoConfig } from './memento-config';

if (import.meta.env.DEV && typeof window.Memento === 'undefined') {
  import('memento-mock').then((module) => {
    module.default({
      enableForwarding: mementoConfig.enabled,
      serverUrl: mementoConfig.serverUrl,
      pairingKey: mementoConfig.pairingKey,
      timeout: mementoConfig.timeout,
    });
  });
}
```

---

## æ¶ˆæ¯åè®®

### 1. è®¤è¯æ¶ˆæ¯

**å‰ç«¯/å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨**

```json
{
  "type": "auth",
  "id": "msg_1767420000000_abc123",
  "timestamp": 1767420000000,
  "role": "frontend" | "client",
  "pairingKey": "ABCD-1234-EFGH-5678",
  "clientInfo": {
    "platform": "web" | "android" | "ios",
    "version": "1.0.0",
    "deviceId": "unique-device-id",
    "deviceName": "My Device"
  }
}
```

### 2. API è¯·æ±‚æ¶ˆæ¯

**å‰ç«¯ â†’ æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯**

```json
{
  "type": "request",
  "id": "msg_1767420000000_def456",
  "timestamp": 1767420000000,
  "requestId": "msg_1767420000000_req789",
  "pluginId": "bill",
  "methodName": "getAccounts",
  "params": {}
}
```

### 3. API å“åº”æ¶ˆæ¯

**å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ â†’ å‰ç«¯**

```json
{
  "type": "response",
  "id": "msg_1767420000000 ghi012",
  "timestamp": 1767420000000,
  "requestId": "msg_1767420000000_req789",
  "success": true,
  "result": [
    {
      "id": "cash-001",
      "name": "ç°é‡‘è´¦æˆ·",
      "balance": 1000.00
    }
  ]
}
```

### 4. å¿ƒè·³æ¶ˆæ¯

**åŒå‘**

```json
// Ping
{
  "type": "ping",
  "id": "msg_1767420000000_ping",
  "timestamp": 1767420000000
}

// Pong
{
  "type": "pong",
  "id": "msg_1767420000000_ping",
  "timestamp": 1767420000000
}
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šå‰ç«¯æ— æ³•è¿æ¥

**ç—‡çŠ¶**ï¼š
```
[WebSocket] é”™è¯¯äº‹ä»¶: Event
[WebSocket] è¿æ¥å·²å…³é—­
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼š`lsof -i :8654`
2. æ£€æŸ¥æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®ï¼š`ws://localhost:8654`
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

---

### é—®é¢˜ 2ï¼šç›¸åŒè§’è‰²çš„è¿æ¥å·²å­˜åœ¨

**ç—‡çŠ¶**ï¼š
```
[WebSocket] æ”¶åˆ°æ¶ˆæ¯: {"type":"response",...,"message":"ç›¸åŒè§’è‰²çš„è¿æ¥å·²å­˜åœ¨"}
```

**åŸå› **ï¼šå‰ç«¯æˆ–å®¢æˆ·ç«¯é‡å¤è¿æ¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å…³é—­æ‰€æœ‰æµè§ˆå™¨æ ‡ç­¾é¡µï¼Œåªä¿ç•™ä¸€ä¸ª
2. ç¡®ä¿ Flutter å®¢æˆ·ç«¯åªè¿æ¥ä¸€æ¬¡
3. æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªåœ°æ–¹åœ¨åˆå§‹åŒ–

---

### é—®é¢˜ 3ï¼šå‰ç«¯æ”¶åˆ°å“åº”ä½†æ•°æ®ä¸ºç©º

**ç—‡çŠ¶**ï¼š
```javascript
let data = await Memento.plugins.bill.getAccounts({});
console.log(data); // undefined
```

**åŸå› **ï¼šå“åº”æ ¼å¼ä¸åŒ¹é…æˆ–è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Flutter æ—¥å¿—ç¡®è®¤æ˜¯å¦è¿”å›æ•°æ®
2. æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ç¡®è®¤æ˜¯å¦è½¬å‘å“åº”
3. å¢åŠ è¶…æ—¶æ—¶é—´æˆ–è®¾ç½® `timeout: 0`

---

### é—®é¢˜ 4ï¼šå®¢æˆ·ç«¯è°ƒç”¨å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
[APIè½¬å‘] è°ƒç”¨å¤±è´¥: Exception: æ’ä»¶ä¸å­˜åœ¨
```

**åŸå› **ï¼šæ’ä»¶ ID æˆ–æ–¹æ³•åé”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤æ’ä»¶å·²åŠ è½½åˆ° JSBridge
2. æ£€æŸ¥æ’ä»¶ ID æ‹¼å†™ï¼ˆå°å†™ï¼‰
3. æ£€æŸ¥æ–¹æ³•åæ˜¯å¦æ­£ç¡®

---

### é—®é¢˜ 5ï¼šé…å¯¹è¶…æ—¶

**ç—‡çŠ¶**ï¼š
```
[WebSocket] æ”¶åˆ°æ¶ˆæ¯: {"type":"response",...,"message":"é…å¯¹è¶…æ—¶"}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å…ˆè¿æ¥å®¢æˆ·ç«¯ï¼Œç­‰å¾…æ˜¾ç¤º"ç­‰å¾…å‰ç«¯è¿æ¥..."
2. å†åˆ·æ–°å‰ç«¯é¡µé¢
3. ç¡®ä¿é…å¯¹å¯†é’¥å®Œå…¨ä¸€è‡´

---

## å¼€å‘è°ƒè¯•

### æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

```bash
cd api_forwarding_server
npm start
```

è¾“å‡ºï¼š
```
[æœåŠ¡å™¨] ç›‘å¬ç«¯å£: 8654
[ä¼šè¯] è®¤è¯è¯·æ±‚: client, key: ABCD-1234-EFGH-5678
[ä¼šè¯] è®¤è¯è¯·æ±‚: frontend, key: ABCD-1234-EFGH-5678
[ä¼šè¯] æ–°ä¼šè¯åˆ›å»º: xxx-xxx-xxx
[ä¼šè¯] xxx: è½¬å‘è¯·æ±‚ msg_123 -> bill.getAccounts
[ä¼šè¯] xxx: è½¬å‘å“åº” msg_123 -> æˆåŠŸ
```

### æŸ¥çœ‹ Flutter æ—¥å¿—

```bash
flutter run
```

è¾“å‡ºï¼š
```
[APIè½¬å‘] æ­£åœ¨è¿æ¥åˆ° ws://localhost:8654...
[APIè½¬å‘] è®¤è¯æˆåŠŸï¼Œå·²åŒ¹é…å¯¹ç«¯
[APIè½¬å‘] è°ƒç”¨: bill.getAccounts
[APIè½¬å‘] è°ƒç”¨æˆåŠŸï¼Œç»“æœ: [...]
```

### æŸ¥çœ‹å‰ç«¯æ—¥å¿—

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰> Console

è¾“å‡ºï¼š
```
[Memento Mock] å¯ç”¨è½¬å‘æ¨¡å¼
[WebSocket] æ­£åœ¨è¿æ¥åˆ° ws://localhost:8654...
[WebSocket] è®¤è¯æˆåŠŸï¼Œå·²åŒ¹é…å¯¹ç«¯
[WebSocket] è°ƒç”¨: bill.getAccounts
[WebSocket] API è°ƒç”¨æˆåŠŸï¼Œç»“æœ: [...]
```

---

## ç›¸å…³æ–‡ä»¶

### æœåŠ¡å™¨ç«¯
- `src/server.ts` - WebSocket æœåŠ¡å™¨
- `src/session.ts` - ä¼šè¯ç®¡ç†
- `src/types.ts` - æ¶ˆæ¯ç±»å‹å®šä¹‰
- `src/index.ts` - å…¥å£æ–‡ä»¶

### Flutter å®¢æˆ·ç«¯
- `lib/core/api_forwarding/api_forwarding_service.dart` - è½¬å‘æœåŠ¡
- `lib/core/api_forwarding/api_forwarding_config.dart` - é…ç½®ç®¡ç†
- `lib/screens/settings_screen/widgets/api_forwarding_settings_dialog.dart` - è®¾ç½®å¯¹è¯æ¡†

### Web å‰ç«¯
- `memento-mock/src/websocket-client.ts` - WebSocket å®¢æˆ·ç«¯
- `memento-mock/src/index.ts` - åˆå§‹åŒ–å’Œ API ä»£ç†

---

## è®¸å¯è¯

MIT
