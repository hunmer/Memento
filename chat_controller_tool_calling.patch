--- a/lib/plugins/agent_chat/controllers/chat_controller.dart
+++ b/lib/plugins/agent_chat/controllers/chat_controller.dart
@@ -244,11 +247,24 @@ class ChatController extends ChangeNotifier {

     final buffer = StringBuffer();
     int tokenCount = 0;
+    bool isCollectingToolCall = false;

     try {
       // æ„å»ºä¸Šä¸‹æ–‡æ¶ˆæ¯
       final contextMessages = _buildContextMessages(userInput);

+      // å¦‚æœå¯ç”¨å·¥å…·è°ƒç”¨ï¼Œæ·»åŠ å·¥å…·åˆ—è¡¨åˆ° system prompt
+      if (_currentAgent!.enableFunctionCalling && contextMessages.isNotEmpty) {
+        final toolsPrompt = ToolService.getToolListPrompt();
+        final originalSystemPrompt = contextMessages[0].content;
+
+        contextMessages[0] = ChatCompletionMessage.system(
+          content: originalSystemPrompt is String
+              ? originalSystemPrompt + toolsPrompt
+              : toolsPrompt,
+        );
+      }
+
       // å¤„ç†æ–‡ä»¶ï¼ˆä»…æ”¯æŒå›¾ç‰‡visionæ¨¡å¼ï¼‰
       final imageFiles = files.where((f) => FilePickerHelper.isImageFile(f)).toList();

@@ -262,17 +278,33 @@ class ChatController extends ChangeNotifier {
           buffer.write(token);
           tokenCount++;

-          // å¤„ç†thinkingæ ‡ç­¾
-          final processedContent =
-              RequestService.processThinkingContent(buffer.toString());
-
-          // æ›´æ–°AIæ¶ˆæ¯
-          messageService.updateAIMessageContent(
-            conversation.id,
-            aiMessageId,
-            processedContent,
-            tokenCount,
-          );
+          final content = buffer.toString();
+
+          // æ£€æµ‹å·¥å…·è°ƒç”¨
+          if (_currentAgent!.enableFunctionCalling &&
+              ToolService.containsToolCall(content)) {
+            isCollectingToolCall = true;
+            // æ˜¾ç¤ºæ”¶é›†ä¸­çŠ¶æ€
+            final displayContent = '$content\n\nâš™ï¸ æ­£åœ¨å‡†å¤‡å·¥å…·è°ƒç”¨...';
+            messageService.updateAIMessageContent(
+              conversation.id,
+              aiMessageId,
+              displayContent,
+              tokenCount,
+            );
+          } else if (!isCollectingToolCall) {
+            // æ­£å¸¸æµå¼æ˜¾ç¤º
+            final processedContent =
+                RequestService.processThinkingContent(content);
+
+            // æ›´æ–°AIæ¶ˆæ¯
+            messageService.updateAIMessageContent(
+              conversation.id,
+              aiMessageId,
+              processedContent,
+              tokenCount,
+            );
+          }
         },
         onError: (error) {
           debugPrint('AIå“åº”é”™è¯¯: $error');
@@ -287,14 +319,19 @@ class ChatController extends ChangeNotifier {

           messageService.completeAIMessage(conversation.id, aiMessageId);
         },
-        onComplete: () {
-          // å®Œæˆç”Ÿæˆ
-          messageService.completeAIMessage(conversation.id, aiMessageId);
-
-          // æ›´æ–°ä¼šè¯çš„æœ€åæ¶ˆæ¯
-          final finalContent = RequestService.processThinkingContent(
-            buffer.toString(),
-          );
+        onComplete: () async {
+          // æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰§è¡Œå·¥å…·è°ƒç”¨
+          if (_currentAgent!.enableFunctionCalling &&
+              ToolService.containsToolCall(buffer.toString())) {
+            await _handleToolCall(aiMessageId, buffer.toString());
+          } else {
+            // å®Œæˆç”Ÿæˆ
+            messageService.completeAIMessage(conversation.id, aiMessageId);
+
+            // æ›´æ–°ä¼šè¯çš„æœ€åæ¶ˆæ¯
+            final finalContent = RequestService.processThinkingContent(
+              buffer.toString(),
+            );
           conversationService.updateLastMessage(
             conversation.id,
             finalContent.length > 50
@@ -302,6 +339,7 @@ class ChatController extends ChangeNotifier {
                 : finalContent,
           );
         },
+        }
         replacePrompt: false, // ä¸æ›¿æ¢prompt
       );
     } catch (e) {
@@ -540,4 +578,134 @@ class ChatController extends ChangeNotifier {

     return messages;
   }
+
+  /// å¤„ç†å·¥å…·è°ƒç”¨
+  Future<void> _handleToolCall(String messageId, String aiResponse) async {
+    try {
+      // 1. è§£æå·¥å…·è°ƒç”¨
+      final toolCall = ToolService.parseToolCallFromResponse(aiResponse);
+      if (toolCall == null) {
+        // è§£æå¤±è´¥ï¼Œç›´æ¥å®Œæˆæ¶ˆæ¯
+        messageService.completeAIMessage(conversation.id, messageId);
+        return;
+      }
+
+      // 2. æ›´æ–°æ¶ˆæ¯æ˜¾ç¤ºè§£æç»“æœ
+      var displayContent = '$aiResponse\n\n';
+
+      // 3. é€æ­¥æ‰§è¡Œå·¥å…·è°ƒç”¨
+      for (int i = 0; i < toolCall.steps.length; i++) {
+        final step = toolCall.steps[i];
+
+        // æ˜¾ç¤ºæ‰§è¡Œä¸­çŠ¶æ€
+        displayContent += '\nğŸ”§ **æ­¥éª¤ ${i + 1}: ${step.title}**\n';
+        displayContent += 'ğŸ“ ${step.desc}\n';
+        displayContent += 'â³ æ­£åœ¨æ‰§è¡Œ...\n';
+        messageService.updateAIMessageContent(
+          conversation.id,
+          messageId,
+          displayContent,
+          TokenCounterService.countTokens(displayContent),
+        );
+
+        // æ‰§è¡Œå·¥å…·è°ƒç”¨
+        if (step.method == 'run_js') {
+          try {
+            final result = await ToolService.executeJsCode(step.data);
+
+            // æ˜¾ç¤ºæˆåŠŸç»“æœ
+            displayContent = displayContent.replaceAll(
+              'â³ æ­£åœ¨æ‰§è¡Œ...',
+              'âœ… æ‰§è¡ŒæˆåŠŸ\n```json\n$result\n```',
+            );
+            messageService.updateAIMessageContent(
+              conversation.id,
+              messageId,
+              displayContent,
+              TokenCounterService.countTokens(displayContent),
+            );
+
+            // æ›´æ–°æ­¥éª¤çŠ¶æ€
+            step.result = result;
+            step.status = ToolCallStatus.success;
+          } catch (e) {
+            // æ˜¾ç¤ºé”™è¯¯å¹¶ä¸­æ–­
+            displayContent = displayContent.replaceAll(
+              'â³ æ­£åœ¨æ‰§è¡Œ...',
+              'âŒ æ‰§è¡Œå¤±è´¥: $e',
+            );
+            messageService.updateAIMessageContent(
+              conversation.id,
+              messageId,
+              displayContent,
+              TokenCounterService.countTokens(displayContent),
+            );
+            messageService.completeAIMessage(conversation.id, messageId);
+            return; // ä¸­æ–­æµç¨‹
+          }
+        }
+      }
+
+      // 4. æ‰€æœ‰å·¥å…·è°ƒç”¨æˆåŠŸï¼Œå°†ç»“æœå‘é€ç»™ AI ç»§ç»­ç”Ÿæˆ
+      final toolResultMessage = _buildToolResultMessage(toolCall.steps);
+      await _continueWithToolResult(messageId, toolResultMessage);
+    } catch (e) {
+      // è§£æå¤±è´¥
+      final errorContent = '$aiResponse\n\nâŒ å·¥å…·è°ƒç”¨å¤„ç†å¤±è´¥: $e';
+      messageService.updateAIMessageContent(
+        conversation.id,
+        messageId,
+        errorContent,
+        TokenCounterService.countTokens(errorContent),
+      );
+      messageService.completeAIMessage(conversation.id, messageId);
+    }
+  }
+
+  /// æ„å»ºå·¥å…·ç»“æœæ¶ˆæ¯
+  String _buildToolResultMessage(List<ToolCallStep> steps) {
+    final buffer = StringBuffer();
+    buffer.writeln('å·¥å…·æ‰§è¡Œç»“æœ:\n');
+
+    for (int i = 0; i < steps.length; i++) {
+      final step = steps[i];
+      buffer.writeln('æ­¥éª¤ ${i + 1}: ${step.title}');
+      if (step.result != null) {
+        buffer.writeln('ç»“æœ: ${step.result}');
+      }
+      buffer.writeln();
+    }
+
+    return buffer.toString();
+  }
+
+  /// ä½¿ç”¨å·¥å…·ç»“æœç»§ç»­å¯¹è¯
+  Future<void> _continueWithToolResult(
+    String originalMessageId,
+    String toolResult,
+  ) async {
+    // å°†å·¥å…·ç»“æœä½œä¸ºç³»ç»Ÿæ¶ˆæ¯æ·»åŠ 
+    final resultMessage = ChatMessage(
+      id: const Uuid().v4(),
+      conversationId: conversation.id,
+      content: toolResult,
+      isUser: false,
+      timestamp: DateTime.now(),
+      metadata: {'isToolResult': true},
+    );
+    await messageService.addMessage(resultMessage);
+
+    // åˆ›å»ºæ–°çš„ AI æ¶ˆæ¯ç»§ç»­ç”Ÿæˆ
+    final newAiMessage = ChatMessage.ai(
+      conversationId: conversation.id,
+      isGenerating: true,
+    );
+    await messageService.addMessage(newAiMessage);
+
+    // é‡æ–°æ„å»ºä¸Šä¸‹æ–‡ï¼ˆåŒ…å«å·¥å…·ç»“æœï¼‰
+    final contextMessages = _buildContextMessages('');
+
+    // ç»§ç»­è¯·æ±‚ AI
+    await _requestAIResponse(newAiMessage.id, '', []);
+  }
 }
