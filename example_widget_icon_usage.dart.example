/// Flutter端使用小组件PNG图标支持的示例代码
///
/// 本文件展示了如何在Flutter端配置小组件数据，传递图标名称而非emoji
/// Android小组件将自动从assets加载对应的PNG图标进行渲染

import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:android/activity_daily_config_screen.dart'; // 需要根据实际路径调整

/// 更新小组件数据，包含图标名称
Future<void> updateWidgetData() async {
  final prefs = await SharedPreferences.getInstance();

  // 1. 定义分组数据 - 使用图标名称而非emoji
  final groups = [
    {
      'id': 'exercise',
      'name': '运动健身',
      'icon': 'fitness_center', // 图标名称，会加载 assets/icons/material/fitness_center.png
    },
    {
      'id': 'study',
      'name': '学习成长',
      'icon': 'school', // 图标名称，会加载 assets/icons/material/school.png
    },
    {
      'id': 'work',
      'name': '工作效率',
      'icon': 'work', // 图标名称，会加载 assets/icons/material/work.png
    },
  ];

  // 2. 定义习惯数据 - 使用图标名称而非emoji
  final habits = [
    {
      'id': 'running',
      'title': '晨跑5公里',
      'icon': 'run_circle', // 图标名称，会加载 assets/icons/material/run_circle.png
      'group': 'exercise',
    },
    {
      'id': 'gym',
      'title': '健身房训练',
      'icon': 'fitness_center', // 图标名称，会加载 assets/icons/material/fitness_center.png
      'group': 'exercise',
    },
    {
      'id': 'reading',
      'title': '阅读30分钟',
      'icon': 'menu_book', // 图标名称，会加载 assets/icons/material/menu_book.png
      'group': 'study',
    },
    {
      'id': 'english',
      'title': '英语学习',
      'icon': 'translate', // 图标名称，会加载 assets/icons/material/translate.png
      'group': 'study',
    },
    {
      'id': 'code',
      'title': '编程练习',
      'icon': 'code', // 图标名称，会加载 assets/icons/material/code.png
      'group': 'work',
    },
    {
      'id': 'meeting',
      'title': '团队会议',
      'icon': 'group', // 图标名称，会加载 assets/icons/material/group.png
      'group': 'work',
    },
  ];

  // 3. 组合数据
  final widgetData = {
    'groups': groups,
    'habits': habits,
  };

  // 4. 保存到SharedPreferences
  await prefs.setString('habit_group_list_widget_data', jsonEncode(widgetData));

  // 5. 刷新所有小组件
  // 注意：这个方法需要通过MethodChannel调用Android原生代码
  // 或者使用 home_widget 插件
  await refreshAllWidgets();
}

/// 获取可用图标列表的示例
List<Map<String, String>> getAvailableIcons() {
  return [
    {'name': '星形', 'value': 'star'},
    {'name': '主页', 'value': 'home'},
    {'name': '设置', 'value': 'settings'},
    {'name': '运动健身', 'value': 'fitness_center'},
    {'name': '学校', 'value': 'school'},
    {'name': '工作', 'value': 'work'},
    {'name': '跑步', 'value': 'run_circle'},
    {'name': '书本', 'value': 'menu_book'},
    {'name': '翻译', 'value': 'translate'},
    {'name': '代码', 'value': 'code'},
    {'name': '群组', 'value': 'group'},
    {'name': '心形', 'value': 'favorite'},
    {'name': '相机', 'value': 'camera'},
    {'name': '音乐', 'value': 'music_note'},
    {'name': '日历', 'value': 'event'},
    // ... 更多图标
  ];
}

/// 图标选择器示例Widget
class IconSelector extends StatefulWidget {
  @override
  _IconSelectorState createState() => _IconSelectorState();
}

class _IconSelectorState extends State<IconSelector> {
  String selectedIcon = 'star'; // 默认图标

  @override
  Widget build(BuildContext context) {
    final icons = getAvailableIcons();

    return Scaffold(
      appBar: AppBar(title: Text('选择图标')),
      body: GridView.builder(
        gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
          crossAxisCount: 4,
          childAspectRatio: 1.0,
        ),
        itemCount: icons.length,
        itemBuilder: (context, index) {
          final icon = icons[index];
          final isSelected = selectedIcon == icon['value'];

          return InkWell(
            onTap: () {
              setState(() {
                selectedIcon = icon['value']!;
              });
            },
            child: Container(
              margin: EdgeInsets.all(8),
              decoration: BoxDecoration(
                border: Border.all(
                  color: isSelected ? Colors.blue : Colors.grey,
                  width: 2,
                ),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  // 显示图标名称
                  Text(
                    icon['name']!,
                    style: TextStyle(fontSize: 12),
                    textAlign: TextAlign.center,
                  ),
                  SizedBox(height: 4),
                  // 显示图标值
                  Text(
                    icon['value']!,
                    style: TextStyle(
                      fontSize: 10,
                      color: Colors.grey[600],
                    ),
                  ),
                ],
              ),
            ),
          );
        },
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () {
          // 使用选中的图标
          Navigator.pop(context, selectedIcon);
        },
        child: Icon(Icons.check),
      ),
    );
  }
}

/// 完整的习惯创建示例，包含图标选择
class CreateHabitScreen extends StatefulWidget {
  @override
  _CreateHabitScreenState createState() => _CreateHabitScreenState();
}

class _CreateHabitScreenState extends State<CreateHabitScreen> {
  final _titleController = TextEditingController();
  String _selectedIcon = 'star';
  String? _selectedGroup;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('创建新习惯')),
      body: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          children: [
            // 习惯名称输入
            TextField(
              controller: _titleController,
              decoration: InputDecoration(
                labelText: '习惯名称',
                hintText: '例如：晨跑5公里',
              ),
            ),
            SizedBox(height: 16),

            // 图标选择
            ListTile(
              title: Text('选择图标'),
              subtitle: Text(_selectedIcon),
              trailing: Icon(Icons.arrow_forward_ios),
              onTap: () async {
                final result = await Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (context) => IconSelector(),
                  ),
                );
                if (result != null) {
                  setState(() {
                    _selectedIcon = result;
                  });
                }
              },
            ),

            Spacer(),

            // 创建按钮
            ElevatedButton(
              onPressed: () {
                if (_titleController.text.isNotEmpty) {
                  _createHabit();
                }
              },
              child: Text('创建习惯'),
            ),
          ],
        ),
      ),
    );
  }

  void _createHabit() async {
    // 这里应该保存到数据库
    final habit = {
      'id': DateTime.now().millisecondsSinceEpoch.toString(),
      'title': _titleController.text,
      'icon': _selectedIcon, // 传递图标名称
      'group': _selectedGroup,
    };

    // 更新小组件数据
    await updateWidgetData();

    // 返回
    Navigator.pop(context);
  }
}

/// 从Flutter更新小组件的示例代码
///
/// 注意：这个方法需要通过MethodChannel调用Android原生代码
/// 或者使用 home_widget 插件的HomeWidget.saveWidgetData方法
Future<void> refreshAllWidgets() async {
  // 方法1：使用 home_widget 插件
  // import 'package:home_widget/home_widget.dart';
  // await HomeWidget.updateWidget(
  //   name: 'HabitGroupListWidgetProvider',
  //   iOSName: 'HabitGroupListWidgetProvider',
  // );

  // 方法2：使用MethodChannel（需要原生代码支持）
  // const platform = MethodChannel('github.hunmer.memento/widget_refresh');
  // await platform.invokeMethod('refreshAllWidgets');

  // 方法3：发送广播（如果小组件支持）
  // 这需要在Android原生代码中实现BroadcastReceiver

  print('请根据实际项目选择合适的刷新方法');
}

/// 查看assets目录中的所有可用图标
Future<void> listAvailableIcons() async {
  // 注意：这个功能需要原生代码支持或文件系统访问权限
  // 这里只是一个示例，展示如何使用

  final commonIcons = [
    'star', 'home', 'settings', 'favorite', 'person',
    'camera', 'music_note', 'book', 'school', 'work',
    'fitness_center', 'restaurant', 'local_cafe', 'shopping_cart',
    'flight', 'car', 'directions_bike', 'directions_walk',
    'run_circle', 'sports_soccer', 'sports_basketball', 'sports_tennis',
    'menu_book', 'library_books', 'translate', 'code',
    'computer', 'phone_android', 'tablet', 'keyboard',
    'event', 'date_range', 'schedule', 'access_time',
    'cloud', 'wifi', 'bluetooth', 'battery_full',
    // ... 更多常用图标
  ];

  print('可用图标列表：');
  for (final icon in commonIcons) {
    print('  - $icon');
  }
}

/// 注意事项：
/// 1. 图标名称必须是小写字母和下划线，不能包含空格或特殊字符
/// 2. 图标文件位于 assets/icons/material/{icon_name}.png
/// 3. 如果指定的图标不存在，小组件会自动回退到默认图标
/// 4. 建议在Flutter应用启动时检查assets目录中的图标是否完整
/// 5. 可以运行 `python scripts/copy_icons.py` 重新复制所有图标
