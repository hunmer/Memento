# AI 工具调用 - 步骤间结果传递功能使用示例

## 功能说明

在 AI 工具调用的多个步骤之间传递和共享数据，支持：
- 通过自定义 ID 存储和获取结果
- 通过步骤索引获取之前步骤的结果
- 自动保存每个步骤的结果
- 支持默认值防止获取失败

## 使用场景

### 场景 1: 基本的步骤间数据传递

**AI 工具调用示例**（两个步骤）：

**步骤 1: 查询今日任务**
```javascript
// 查询今日待办任务
const tasks = await Memento.plugins.todo.getTodayTasks();

// 保存结果供后续步骤使用
await Memento.toolCall.setResult({
  id: 'todayTasks',
  value: tasks
});

// 返回结果
return JSON.stringify({
  count: tasks.length,
  tasks: tasks
});
```

**步骤 2: 分析任务并生成报告**
```javascript
// 获取步骤 1 的结果
const tasks = await Memento.toolCall.getResult({
  id: 'todayTasks'
});

// 或者通过步骤索引获取
// const tasks = await Memento.toolCall.getResult({step: 0});

// 分析任务
const completedCount = tasks.filter(t => t.status === 'completed').length;
const pendingCount = tasks.filter(t => t.status === 'pending').length;

// 生成报告
const report = {
  total: tasks.length,
  completed: completedCount,
  pending: pendingCount,
  completionRate: (completedCount / tasks.length * 100).toFixed(1) + '%'
};

return JSON.stringify(report);
```

---

### 场景 2: 使用默认值处理可选结果

```javascript
// 尝试获取用户配置，如果不存在则使用默认值
const config = await Memento.toolCall.getResult({
  id: 'userConfig',
  default: {
    theme: 'light',
    language: 'zh_CN',
    notifications: true
  }
});

// 使用配置
const theme = config.theme;
```

---

### 场景 3: 复杂的数据处理流程

**步骤 1: 获取原始数据**
```javascript
const rawData = await Memento.plugins.activity.getActivities({
  startDate: '2025-01-01',
  endDate: '2025-01-31'
});

await Memento.toolCall.setResult({
  id: 'rawActivities',
  value: rawData
});

return `已获取 ${rawData.length} 条活动记录`;
```

**步骤 2: 数据清洗**
```javascript
const rawData = await Memento.toolCall.getResult({step: 0});

// 清洗数据：去重、过滤无效记录
const cleanedData = rawData
  .filter(item => item.duration > 0)
  .filter((item, index, self) =>
    self.findIndex(t => t.id === item.id) === index
  );

await Memento.toolCall.setResult({
  id: 'cleanedActivities',
  value: cleanedData
});

return `清洗后剩余 ${cleanedData.length} 条有效记录`;
```

**步骤 3: 数据统计**
```javascript
const activities = await Memento.toolCall.getResult({
  id: 'cleanedActivities'
});

// 按类型统计
const stats = {};
activities.forEach(item => {
  const type = item.type || 'unknown';
  stats[type] = (stats[type] || 0) + item.duration;
});

// 保存最终结果
await Memento.toolCall.setResult({
  id: 'statistics',
  value: stats
});

return JSON.stringify(stats, null, 2);
```

---

## API 参考

### `Memento.toolCall.setResult(params)`

存储结果到当前工具调用上下文。

**参数**：
- `params.id` (可选): 自定义结果 ID
- `params.value` (必需): 要存储的值（任意 JSON 可序列化的数据）

**示例**：
```javascript
// 使用自定义 ID
await Memento.toolCall.setResult({
  id: 'userData',
  value: {name: 'Alice', age: 30}
});

// 不指定 ID，自动使用当前步骤索引 (step_0, step_1, ...)
await Memento.toolCall.setResult({
  value: [1, 2, 3, 4, 5]
});
```

---

### `Memento.toolCall.getResult(params)`

从当前工具调用上下文获取结果。

**参数**：
- `params.id` (可选): 要获取的结果 ID
- `params.step` (可选): 要获取的步骤索引（从 0 开始）
- `params.default` (可选): 如果结果不存在时返回的默认值

**注意**：`id` 和 `step` 至少要提供一个。

**示例**：
```javascript
// 通过自定义 ID 获取
const userData = await Memento.toolCall.getResult({
  id: 'userData'
});

// 通过步骤索引获取（获取步骤 0 的结果）
const firstStepResult = await Memento.toolCall.getResult({
  step: 0
});

// 带默认值
const config = await Memento.toolCall.getResult({
  id: 'config',
  default: {theme: 'light'}
});
```

---

## 自动保存机制

每个步骤执行成功后，系统会**自动**将结果保存到 `step_N` 键（N 为步骤索引），因此即使不显式调用 `setResult`，也可以在后续步骤中通过索引获取：

```javascript
// 步骤 1 - 不需要显式 setResult
const tasks = await Memento.plugins.todo.getTodayTasks();
return JSON.stringify(tasks);

// 步骤 2 - 可以直接通过索引获取步骤 1 的结果
const tasks = await Memento.toolCall.getResult({step: 0});
const parsedTasks = JSON.parse(tasks);  // 注意：需要解析 JSON
```

---

## 注意事项

1. **作用域限制**：结果仅在当前工具调用内有效，工具调用完成后会自动清除。

2. **JSON 序列化**：
   - `setResult` 的 `value` 必须是 JSON 可序列化的数据。
   - 自动保存的步骤结果是字符串格式，获取时可能需要 `JSON.parse()`。

3. **错误处理**：
   - 如果获取不存在的结果且未提供 `default`，会抛出异常。
   - 建议在不确定结果是否存在时总是提供 `default` 值。

4. **性能考虑**：
   - 结果存储在内存中，避免存储过大的数据。
   - 每个工具调用的结果会在完成后自动清除。

---

## 最佳实践

### ✅ 推荐做法

```javascript
// 1. 为重要数据使用语义化的 ID
await Memento.toolCall.setResult({
  id: 'processedUserData',
  value: processedData
});

// 2. 总是提供默认值以防获取失败
const config = await Memento.toolCall.getResult({
  id: 'appConfig',
  default: DEFAULT_CONFIG
});

// 3. 使用步骤索引获取连续步骤的结果
const previousResult = await Memento.toolCall.getResult({
  step: i - 1
});
```

### ❌ 避免的做法

```javascript
// 1. 不要依赖不存在的结果而不提供默认值
const data = await Memento.toolCall.getResult({id: 'mayNotExist'});  // 可能抛出异常

// 2. 不要存储循环引用的对象
await Memento.toolCall.setResult({
  id: 'circularObj',
  value: objWithCircularRef  // 会导致序列化失败
});

// 3. 不要在非工具调用的 JS 代码中使用
// (setResult/getResult 仅在工具调用步骤中可用)
```

---

## 技术实现细节

### 存储结构

```dart
// JSBridgeManager 中的存储
Map<String, Map<String, dynamic>> _toolCallContexts = {
  "messageId_abc123": {
    "step_0": {"tasks": [...]},        // 自动保存的步骤结果
    "step_1": {"stats": {...}},
    "userData": {"name": "Alice"},     // 自定义 ID 的结果
    "config": {"theme": "dark"}
  }
};
```

### 生命周期

```
1. 工具调用开始
   ↓
2. initToolCallContext(messageId)  // 创建空上下文
   ↓
3. 执行步骤 0
   ↓ setCurrentExecution(messageId, 0)
   ↓ 执行 JavaScript
   ↓ setResult({id: 'data', value: ...})  // 用户手动保存
   ↓ 自动保存到 step_0                     // 系统自动保存
   ↓
4. 执行步骤 1
   ↓ setCurrentExecution(messageId, 1)
   ↓ getResult({id: 'data'})               // 获取步骤 0 的数据
   ↓
5. 所有步骤完成
   ↓
6. clearToolCallContext(messageId)        // 清除上下文
```

---

## 调试技巧

### 查看存储的结果

在 JavaScript 中打印日志（如果支持）：
```javascript
console.log('Saving result:', JSON.stringify(myData));
await Memento.toolCall.setResult({id: 'debug', value: myData});
```

### 检查 Dart 日志

在 Flutter 控制台中查找：
```
[JSBridge] 设置结果: userData = {name: Alice, age: 30}
[JSBridge] 获取结果: userData = {name: Alice, age: 30}
[JSBridge] 初始化工具调用上下文: msg_abc123
[JSBridge] 清除工具调用上下文: msg_abc123
```

---

**更新时间**: 2025-11-19
**功能版本**: v1.0
