# AI èŠå¤©åå°æœåŠ¡æµ‹è¯•æŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²å®ç° AI èŠå¤©åå°æœåŠ¡ï¼Œæ”¯æŒåœ¨åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨åç»§ç»­æ¥æ”¶ AI å›å¤å¹¶æ˜¾ç¤ºé€šçŸ¥ã€‚

### å®ç°çš„åŠŸèƒ½
- âœ… Android å‰å°æœåŠ¡ï¼ˆæ˜¾ç¤ºæŒç»­é€šçŸ¥ï¼‰
- âœ… åˆ‡æ¢APPåç»§ç»­ç”ŸæˆAIå›å¤
- âœ… ç”Ÿæˆå®Œæˆåæ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥
- âœ… é€šçŸ¥æŒ‰é’®æ”¯æŒå–æ¶ˆç”Ÿæˆ
- âœ… ç‚¹å‡»é€šçŸ¥è¿”å›èŠå¤©ç•Œé¢
- âœ… ç”Ÿæˆè¿›åº¦å®æ—¶æ›´æ–°
- âœ… é”™è¯¯å¤„ç†å’Œé€šçŸ¥

### å¹³å°æ”¯æŒ
- âœ… **Android**: å®Œæ•´æ”¯æŒï¼ˆå‰å°æœåŠ¡ + åå°è¿è¡Œï¼‰
- âš ï¸ **iOS**: ä»…å‰å°æ”¯æŒï¼ˆçº¦30ç§’åå°æ—¶é—´ï¼‰
- âŒ **Web/Desktop**: ä¸æ”¯æŒåå°æœåŠ¡

---

## ğŸ”§ å®ç°æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
1. **`lib/plugins/agent_chat/services/chat_task_handler.dart`**
   - AI èŠå¤©åå°ä»»åŠ¡å¤„ç†å™¨
   - åœ¨ç‹¬ç«‹ isolate ä¸­è¿è¡Œ
   - å¤„ç†é€šçŸ¥æ›´æ–°å’Œç”¨æˆ·äº¤äº’

### ä¿®æ”¹æ–‡ä»¶
2. **`lib/plugins/agent_chat/controllers/chat_controller.dart`**
   - é›†æˆå‰å°æœåŠ¡ç®¡ç†å™¨
   - æ·»åŠ ç”ŸæˆçŠ¶æ€é€šçŸ¥
   - å®ç°åå°æœåŠ¡é€šä¿¡

### ä¾èµ–æ–‡ä»¶ï¼ˆå·²å­˜åœ¨ï¼‰
3. **`lib/core/services/foreground_task_manager.dart`**
   - å‰å°æœåŠ¡ç®¡ç†å™¨å°è£…
4. **`lib/core/notification_controller.dart`**
   - ç³»ç»Ÿé€šçŸ¥ç®¡ç†å™¨
5. **`android/app/src/main/AndroidManifest.xml`**
   - å·²é…ç½®å¿…è¦æƒé™å’ŒæœåŠ¡

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### å‡†å¤‡å·¥ä½œ

1. **ç¡®ä¿è®¾å¤‡/æ¨¡æ‹Ÿå™¨è¿è¡Œ Android**
   ```bash
   flutter devices
   ```

2. **æ„å»ºå¹¶å®‰è£…åº”ç”¨**
   ```bash
   flutter run --release
   # æˆ–
   flutter build apk && adb install build/app/outputs/flutter-apk/app-release.apk
   ```

3. **æˆäºˆå¿…è¦æƒé™**
   - é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨è¯·æ±‚é€šçŸ¥æƒé™
   - æ‰‹åŠ¨æ£€æŸ¥ï¼šè®¾ç½® > åº”ç”¨ > Memento > æƒé™ > é€šçŸ¥ï¼ˆå…è®¸ï¼‰

---

### æµ‹è¯•åœºæ™¯ 1: åŸºæœ¬åå°ç”Ÿæˆ

**ç›®æ ‡**: éªŒè¯åˆ‡æ¢APPåAIç»§ç»­ç”Ÿæˆ

**æ­¥éª¤**:
1. æ‰“å¼€ Memento åº”ç”¨
2. è¿›å…¥èŠå¤©æ’ä»¶ï¼ˆagent_chatï¼‰
3. è¾“å…¥ä¸€ä¸ªéœ€è¦è¾ƒé•¿æ—¶é—´å›å¤çš„é—®é¢˜ï¼ˆä¾‹å¦‚ï¼š"è¯·ç”¨500å­—ä»‹ç»Flutteræ¡†æ¶"ï¼‰
4. ç‚¹å‡»å‘é€
5. **ç«‹å³æŒ‰ Home é”®**åˆ‡æ¢åˆ°æ¡Œé¢æˆ–å…¶ä»–åº”ç”¨
6. **è§‚å¯Ÿé€šçŸ¥æ **

**é¢„æœŸç»“æœ**:
- âœ… é€šçŸ¥æ æ˜¾ç¤º "AIåŠ©æ‰‹è¿è¡Œä¸­"
- âœ… é€šçŸ¥æ–‡æœ¬æ˜¾ç¤º "AIæ­£åœ¨ç”Ÿæˆå›å¤..."ï¼ˆå¸¦åŠ¨ç”»ç‚¹ï¼‰
- âœ… é€šçŸ¥ä¸­æœ‰ "å–æ¶ˆ" æŒ‰é’®
- âœ… ç”Ÿæˆå®Œæˆåé€šçŸ¥æ›´æ–°ä¸º "AIå›å¤å®Œæˆ"
- âœ… æ˜¾ç¤ºç‹¬ç«‹çš„ç³»ç»Ÿé€šçŸ¥ "ğŸ’¬ AIå›å¤å®Œæˆ"

---

### æµ‹è¯•åœºæ™¯ 2: é€šçŸ¥äº¤äº’

**ç›®æ ‡**: éªŒè¯ç‚¹å‡»é€šçŸ¥å’ŒæŒ‰é’®çš„åŠŸèƒ½

**æ­¥éª¤**:
1. æ‰§è¡Œæµ‹è¯•åœºæ™¯ 1 çš„æ­¥éª¤ 1-5
2. åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œç‚¹å‡»é€šçŸ¥æ çš„ **"å–æ¶ˆ" æŒ‰é’®**

**é¢„æœŸç»“æœ**:
- âœ… AI ç”Ÿæˆç«‹å³åœæ­¢
- âœ… é€šçŸ¥æ›´æ–°ä¸º "AIç”Ÿæˆå·²å–æ¶ˆ"
- âœ… è¿”å›åº”ç”¨åæ¶ˆæ¯æ˜¾ç¤º "ç”¨æˆ·å·²å–æ¶ˆæ“ä½œ"

**æ­¥éª¤**:
3. å†æ¬¡å‘é€æ¶ˆæ¯å¹¶åˆ‡æ¢åˆ°åå°
4. ç­‰å¾…ç”Ÿæˆå®Œæˆåï¼Œ**ç‚¹å‡»é€šçŸ¥æœ¬ä½“**ï¼ˆä¸æ˜¯æŒ‰é’®ï¼‰

**é¢„æœŸç»“æœ**:
- âœ… åº”ç”¨è‡ªåŠ¨æ‰“å¼€åˆ°èŠå¤©ç•Œé¢
- âœ… æ˜¾ç¤ºå®Œæ•´çš„ AI å›å¤

---

### æµ‹è¯•åœºæ™¯ 3: é”™è¯¯å¤„ç†

**ç›®æ ‡**: éªŒè¯ç½‘ç»œé”™è¯¯æ—¶çš„é€šçŸ¥

**æ­¥éª¤**:
1. **å…³é—­ç½‘ç»œè¿æ¥**ï¼ˆé£è¡Œæ¨¡å¼æˆ–æ–­å¼€WiFiï¼‰
2. å‘é€æ¶ˆæ¯
3. åˆ‡æ¢åˆ°åå°

**é¢„æœŸç»“æœ**:
- âœ… é€šçŸ¥æ˜¾ç¤º "AIå›å¤å¤±è´¥"
- âœ… æ˜¾ç¤ºé”™è¯¯åŸå› ï¼ˆç½‘ç»œè¿æ¥å¤±è´¥ï¼‰
- âœ… å‰å°æœåŠ¡è‡ªåŠ¨åœæ­¢

---

### æµ‹è¯•åœºæ™¯ 4: å·¥å…·è°ƒç”¨æµç¨‹

**ç›®æ ‡**: éªŒè¯å¸¦å·¥å…·è°ƒç”¨çš„é•¿æµç¨‹

**æ­¥éª¤**:
1. å‘é€éœ€è¦å·¥å…·è°ƒç”¨çš„è¯·æ±‚
2. åˆ‡æ¢åˆ°åå°
3. è§‚å¯Ÿé€šçŸ¥å˜åŒ–

**é¢„æœŸç»“æœ**:
- âœ… ç¬¬ä¸€é˜¶æ®µ: "AIæ€è€ƒå®Œæˆï¼Œå‡†å¤‡æ‰§è¡Œ..."
- âœ… å·¥å…·æ‰§è¡ŒæœŸé—´: é€šçŸ¥æŒç»­æ˜¾ç¤º
- âœ… æœ€ç»ˆå®Œæˆ: "AIå›å¤å®Œæˆ" + ç³»ç»Ÿé€šçŸ¥

---

### æµ‹è¯•åœºæ™¯ 5: å¤šæ¬¡åˆ‡æ¢

**ç›®æ ‡**: éªŒè¯å‰åå°å¤šæ¬¡åˆ‡æ¢çš„ç¨³å®šæ€§

**æ­¥éª¤**:
1. å‘é€æ¶ˆæ¯
2. åˆ‡æ¢åˆ°åå°ï¼ˆHome é”®ï¼‰
3. è¿”å›åº”ç”¨ï¼ˆç‚¹å‡»å›¾æ ‡æˆ–é€šçŸ¥ï¼‰
4. å†æ¬¡åˆ‡æ¢åˆ°åå°
5. ç­‰å¾…å®Œæˆ

**é¢„æœŸç»“æœ**:
- âœ… åˆ‡æ¢è¿‡ç¨‹ä¸­ AI ç”Ÿæˆä¸ä¸­æ–­
- âœ… é€šçŸ¥çŠ¶æ€æ­£ç¡®åŒæ­¥
- âœ… è¿”å›åº”ç”¨åç•Œé¢æ­£å¸¸æ˜¾ç¤ºç”Ÿæˆè¿›åº¦

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: é€šçŸ¥ä¸æ˜¾ç¤º

**å¯èƒ½åŸå› **:
- é€šçŸ¥æƒé™æœªæˆäºˆ
- ç³»ç»Ÿçœç”µæ¨¡å¼é™åˆ¶

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥é€šçŸ¥æƒé™
adb shell dumpsys notification

# æ£€æŸ¥åº”ç”¨ç”µæ± ä¼˜åŒ–çŠ¶æ€
adb shell dumpsys deviceidle whitelist
```

æ‰‹åŠ¨æ“ä½œ:
- è®¾ç½® > åº”ç”¨ > Memento > æƒé™ > é€šçŸ¥ï¼ˆå¼€å¯ï¼‰
- è®¾ç½® > ç”µæ±  > ç”µæ± ä¼˜åŒ– > Mementoï¼ˆä¸ä¼˜åŒ–ï¼‰

---

### é—®é¢˜ 2: åˆ‡æ¢åå°åæœåŠ¡ç«‹å³åœæ­¢

**å¯èƒ½åŸå› **:
- Android 12+ åå°æœåŠ¡é™åˆ¶
- åº”ç”¨è¢«ç³»ç»Ÿå¼ºåˆ¶åœæ­¢

**è§£å†³æ–¹æ³•**:
1. ç¡®ä¿å‰å°é€šçŸ¥æ­£å¸¸æ˜¾ç¤º
2. æ£€æŸ¥ AndroidManifest.xml æƒé™é…ç½®
3. åœ¨å¼€å‘è€…é€‰é¡¹ä¸­å…³é—­ "ä¸ä¿ç•™æ´»åŠ¨"

---

### é—®é¢˜ 3: ç”Ÿæˆå®Œæˆåæ²¡æœ‰ç³»ç»Ÿé€šçŸ¥

**å¯èƒ½åŸå› **:
- `_isInChatScreen()` åˆ¤æ–­ä¸ºåœ¨å‰å°

**è°ƒè¯•æ–¹æ³•**:
```dart
// åœ¨ chat_controller.dart:2017 æ·»åŠ æ—¥å¿—
bool _isInChatScreen() {
  final lifecycleState = WidgetsBinding.instance.lifecycleState;
  debugPrint('ğŸ” [lifecycleState] $lifecycleState');  // æ·»åŠ è¿™è¡Œ
  if (lifecycleState != AppLifecycleState.resumed) {
    return false;
  }
  return true;
}
```

---

### é—®é¢˜ 4: å‰å°æœåŠ¡æ— æ³•å¯åŠ¨

**é”™è¯¯æ—¥å¿—ç¤ºä¾‹**:
```
âŒ [ChatController] å¯åŠ¨å‰å°æœåŠ¡å¤±è´¥: ForegroundServiceStartNotAllowedException
```

**åŸå› **: Android 12+ é™åˆ¶åå°å¯åŠ¨å‰å°æœåŠ¡

**è§£å†³æ–¹æ³•**:
- ç¡®ä¿åœ¨åº”ç”¨åœ¨å‰å°æ—¶å¯åŠ¨æœåŠ¡ï¼ˆsendMessage æ—¶å·²æ»¡è¶³ï¼‰
- æ£€æŸ¥æ˜¯å¦æœ‰ `FOREGROUND_SERVICE` æƒé™

---

## ğŸ“Š æ—¥å¿—ç›‘æ§

### æŸ¥çœ‹å®Œæ•´æ—¥å¿—
```bash
# å®æ—¶æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
adb logcat | grep -E "ChatController|åå°æœåŠ¡|ForegroundTask"

# è¿‡æ»¤å…³é”®äº‹ä»¶
adb logcat | grep -E "ğŸš€|âœ…|âŒ|ğŸ“¨|ğŸ¤–"
```

### å…³é”®æ—¥å¿—æ ‡è®°
- `ğŸš€` - æœåŠ¡å¯åŠ¨
- `âœ…` - æ“ä½œæˆåŠŸ
- `âŒ` - é”™è¯¯å‘ç”Ÿ
- `ğŸ“¨` - æ•°æ®é€šä¿¡
- `ğŸ¤–` - åå°æœåŠ¡äº‹ä»¶

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. å¼ºåˆ¶è§¦å‘åå°åœºæ™¯
```bash
# æ¨¡æ‹Ÿåº”ç”¨è¿›å…¥åå°
adb shell input keyevent KEYCODE_HOME

# æ¨¡æ‹Ÿé€šçŸ¥ç‚¹å‡»
adb shell am start -n github.hunmer.memento/.MainActivity --es route "/chat"
```

### 2. æ£€æŸ¥å‰å°æœåŠ¡çŠ¶æ€
```bash
# æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„æœåŠ¡
adb shell dumpsys activity services | grep -A 10 "ForegroundService"
```

### 3. ç›‘æ§é€šçŸ¥
```bash
# å®æ—¶ç›‘æ§é€šçŸ¥äº‹ä»¶
adb logcat | grep NotificationManager
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### é¢„æœŸæ€§èƒ½
- **æœåŠ¡å¯åŠ¨æ—¶é—´**: < 500ms
- **é€šçŸ¥æ›´æ–°å»¶è¿Ÿ**: < 100ms
- **é€šçŸ¥æ˜¾ç¤ºå»¶è¿Ÿ**: < 200ms
- **å†…å­˜å ç”¨å¢åŠ **: < 10MB

### ç›‘æ§å‘½ä»¤
```bash
# ç›‘æ§å†…å­˜ä½¿ç”¨
adb shell dumpsys meminfo github.hunmer.memento

# ç›‘æ§CPUä½¿ç”¨
adb shell top | grep memento
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### å¿…é¡»é€šè¿‡çš„æµ‹è¯•
- [ ] åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨å AI ç»§ç»­ç”Ÿæˆ
- [ ] ç”Ÿæˆå®Œæˆåæ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥
- [ ] ç‚¹å‡»é€šçŸ¥èƒ½è¿”å›èŠå¤©ç•Œé¢
- [ ] å–æ¶ˆæŒ‰é’®èƒ½åœæ­¢ç”Ÿæˆ
- [ ] ç½‘ç»œé”™è¯¯æ—¶æ˜¾ç¤ºé”™è¯¯é€šçŸ¥
- [ ] å¤šæ¬¡åˆ‡æ¢åº”ç”¨ä¸å´©æºƒ

### å¯é€‰ä¼˜åŒ–ï¼ˆæœªæ¥æ”¹è¿›ï¼‰
- [ ] æ”¯æŒå¤šä¸ªå¹¶å‘ç”Ÿæˆä»»åŠ¡
- [ ] è‡ªå®šä¹‰é€šçŸ¥å£°éŸ³å’ŒæŒ¯åŠ¨
- [ ] é€šçŸ¥ä¸­æ˜¾ç¤ºç”Ÿæˆè¿›åº¦ç™¾åˆ†æ¯”
- [ ] æ”¯æŒå¿«é€Ÿå›å¤åŠŸèƒ½

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœåå°æœåŠ¡å‡ºç°ä¸¥é‡é—®é¢˜ï¼Œå¯ä»¥ä¸´æ—¶ç¦ç”¨ï¼š

**æ–¹æ³• 1**: ä»£ç çº§ç¦ç”¨
```dart
// åœ¨ chat_controller.dart:297 æ³¨é‡Šæ‰
// if (!kIsWeb && Platform.isAndroid) {
//   await _startAIChatService(conversation.id, aiMessage.id);
// }
```

**æ–¹æ³• 2**: ç”¨æˆ·è®¾ç½®ï¼ˆæœªå®ç°ï¼Œå¯æ‰©å±•ï¼‰
```dart
// åœ¨è®¾ç½®ä¸­æ·»åŠ å¼€å…³
final enableBackgroundService = settings['enableBackgroundService'] ?? false;
if (enableBackgroundService && !kIsWeb && Platform.isAndroid) {
  await _startAIChatService(conversation.id, aiMessage.id);
}
```

---

## ğŸ“ è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
- Android ç‰ˆæœ¬
- åº”ç”¨ç‰ˆæœ¬
- å®Œæ•´æ—¥å¿—ï¼ˆ`adb logcat > log.txt`ï¼‰
- å¤ç°æ­¥éª¤

---

**æµ‹è¯•å®Œæˆåè®°å¾—æ ‡è®°**: `[x] AI åå°æœåŠ¡æµ‹è¯•é€šè¿‡`

**æœ€åæ›´æ–°**: 2025-11-20
**ç‰ˆæœ¬**: v1.0.0
